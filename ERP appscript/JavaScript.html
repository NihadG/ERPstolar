<script>
    // ============================================
    // GLOBAL STATE
    // ============================================
    let appState = {
        projects: [],
        materials: [],
        suppliers: [],
        workers: [],
        offers: [],
        orders: [],
        productMaterials: [],
        currentModal: null,
        lastSync: null
    };

    // ============================================
    // LOCALSTORAGE CACHE SYSTEM
    // ============================================
    const CACHE_KEY = 'erp_app_cache';
    const CACHE_EXPIRY = 1000 * 60 * 60; // 1 hour

    function saveToCache(data) {
        try {
            const cacheData = {
                data: data,
                timestamp: Date.now()
            };
            localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
        } catch (e) {
            console.warn('Cache save failed:', e);
        }
    }

    function loadFromCache() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const parsed = JSON.parse(cached);
                // Check if cache is still valid (within 1 hour)
                if (Date.now() - parsed.timestamp < CACHE_EXPIRY) {
                    return parsed.data;
                }
            }
        } catch (e) {
            console.warn('Cache load failed:', e);
        }
        return null;
    }

    function clearCache() {
        localStorage.removeItem(CACHE_KEY);
    }

    function initializeTabs() {
        const tabs = document.querySelectorAll('.tab:not(.tab-more)');
        const dropdownItems = document.querySelectorAll('.tab-dropdown-item');
        const tabDropdown = document.querySelector('.tab-dropdown');
        const settingsBtn = document.getElementById('settings-tab-btn');

        // Regular tab clicks
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                activateTab(tab.dataset.tab);
                // Close dropdown if open
                if (tabDropdown) tabDropdown.classList.remove('open');
            });
        });

        // Dropdown item clicks
        dropdownItems.forEach(item => {
            item.addEventListener('click', () => {
                activateTab(item.dataset.tab);
                // Mark dropdown item as active
                dropdownItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                // Close dropdown
                if (tabDropdown) tabDropdown.classList.remove('open');
            });
        });

        // Settings dropdown toggle
        if (settingsBtn) {
            settingsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                tabDropdown.classList.toggle('open');
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (tabDropdown && !e.target.closest('.tab-dropdown')) {
                tabDropdown.classList.remove('open');
            }
        });
    }

    function activateTab(tabName) {
        // Remove active from all tabs
        document.querySelectorAll('.tab:not(.tab-more)').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-dropdown-item').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        // Find and activate the correct tab button
        const tabBtn = document.querySelector(`.tab[data-tab="${tabName}"]`);
        const dropdownItem = document.querySelector(`.tab-dropdown-item[data-tab="${tabName}"]`);

        if (tabBtn) tabBtn.classList.add('active');
        if (dropdownItem) dropdownItem.classList.add('active');

        // Activate content
        const tabId = tabName + '-content';
        const tabContent = document.getElementById(tabId);
        if (tabContent) tabContent.classList.add('active');
    }

    // ============================================
    // INITIALIZATION - INSTANT FROM CACHE
    // ============================================
    document.addEventListener('DOMContentLoaded', function () {
        initializeTabs();

        // Step 1: Load from cache IMMEDIATELY (instant!)
        const cachedData = loadFromCache();
        if (cachedData) {
            console.log('‚ö° Loading from cache (instant)');
            applyDataToState(cachedData);
            renderAll();

            // Show subtle indicator that we're syncing
            showSyncIndicator();
        } else {
            console.log('No cache, loading fresh...');
            showLoading();
        }

        // Step 2: Sync with server in background
        syncWithServer();
    });

    function applyDataToState(data) {
        appState.projects = data.projects || [];
        appState.materials = data.materials || [];
        appState.suppliers = data.suppliers || [];
        appState.workers = data.workers || [];
        appState.offers = data.offers || [];
        appState.orders = data.orders || [];
        appState.productMaterials = data.productMaterials || [];
        appState.lastSync = data.timestamp || Date.now();
    }

    function renderAll() {
        renderProjects();
        renderMaterials();
        renderSuppliers();
        renderWorkers();
        renderOffers();
        renderOrders();
    }

    function showSyncIndicator() {
        // Optionally show a small "syncing..." indicator
        console.log('üîÑ Syncing with server...');
    }

    function hideSyncIndicator() {
        console.log('‚úÖ Sync complete');
    }

    function syncWithServer() {
        google.script.run
            .withSuccessHandler(function (data) {
                console.log('‚úÖ Server data received');

                // Update state and cache
                applyDataToState(data);
                data.timestamp = Date.now();
                saveToCache(data);

                // Re-render only if data changed
                renderAll();
                hideLoading();
                hideSyncIndicator();
            })
            .withFailureHandler(function (err) {
                console.error('Sync failed:', err);
                hideLoading();
                hideSyncIndicator();
                // Still usable with cached data!
            })
            .getAllData();
    }

    // Force refresh (manual)
    function forceRefresh() {
        clearCache();
        showLoading();
        syncWithServer();
    }

    // Legacy function - now uses cache
    function loadAllData() {
        syncWithServer();
    }

    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    function runAsync(functionName, ...args) {
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
            [functionName](...args);
        });
    }

    function showLoading() {
        document.getElementById('loading-overlay').classList.add('active');
    }

    function hideLoading() {
        document.getElementById('loading-overlay').classList.remove('active');
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
    <span class="material-icons-round">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}</span>
    ${message}
  `;
        container.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 4000);
    }

    function formatCurrency(amount) {
        return parseFloat(amount || 0).toFixed(2) + ' KM';
    }

    function getStatusClass(status) {
        if (!status) return '';
        return 'status-' + status.toLowerCase()
            .replace(/\s+/g, '-')
            .replace(/ƒç/g, 'c')
            .replace(/≈æ/g, 'z')
            .replace(/≈°/g, 's');
    }

    // ============================================
    // MODAL FUNCTIONS
    // ============================================
    function openModal(modalId) {
        document.getElementById('modal-overlay').classList.add('active');
        document.getElementById(modalId).classList.add('active');
        appState.currentModal = modalId;
    }

    function closeModal() {
        document.getElementById('modal-overlay').classList.remove('active');
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        appState.currentModal = null;
    }

    // ============================================
    // PROJECTS
    // ============================================
    function renderProjects() {
        const container = document.getElementById('projects-list');
        const search = document.getElementById('projects-search').value.toLowerCase();
        const filter = document.getElementById('projects-filter').value;

        let filtered = appState.projects;

        if (search) {
            filtered = filtered.filter(p =>
                p.Client_Name?.toLowerCase().includes(search) ||
                p.Address?.toLowerCase().includes(search)
            );
        }

        if (filter) {
            filtered = filtered.filter(p => p.Status === filter);
        }

        if (filtered.length === 0) {
            container.innerHTML = `
      <div class="empty-state">
        <span class="material-icons-round">folder_open</span>
        <h3>Nema projekata</h3>
        <p>Kliknite "Novi Projekat" da zapoƒçnete</p>
      </div>
    `;
            return;
        }

        container.innerHTML = filtered.map(project => `
    <div class="project-card" data-id="${project.Project_ID}">
      <div class="project-header" onclick="toggleProject('${project.Project_ID}')">
        <button class="expand-btn" id="expand-${project.Project_ID}">
          <span class="material-icons-round">chevron_right</span>
        </button>
        <div class="project-info">
          <div class="project-name">${project.Client_Name || 'Bez naziva'}</div>
          <div class="project-client">${project.Address || 'Adresa nije unesena'}</div>
        </div>
        <div class="project-meta">
          <span class="mode-badge">${project.Production_Mode === 'PreCut' ? 'Gotovi elementi' : 'Vlastita obrada'}</span>
          <span class="status-badge ${getStatusClass(project.Status)}">${project.Status || 'Nacrt'}</span>
        </div>
        <div class="project-actions" onclick="event.stopPropagation()">
          <button class="icon-btn" onclick="openOfferModalForProject('${project.Project_ID}')" title="Kreiraj ponudu">
            <span class="material-icons-round">request_quote</span>
          </button>
          <button class="icon-btn" onclick="editProject('${project.Project_ID}')" title="Uredi">
            <span class="material-icons-round">edit</span>
          </button>
          <button class="icon-btn danger" onclick="confirmDeleteProject('${project.Project_ID}')" title="Obri≈°i">
            <span class="material-icons-round">delete</span>
          </button>
        </div>
      </div>
      <div class="project-products" id="products-${project.Project_ID}">
        <div class="products-header">
          <h4>Proizvodi (${(project.products || []).length})</h4>
          <button class="btn btn-sm btn-secondary" onclick="openProductModal('${project.Project_ID}')">
            <span class="material-icons-round">add</span> Dodaj proizvod
          </button>
        </div>
        ${renderProducts(project.products || [], project.Project_ID)}
      </div>
    </div>
  `).join('');
    }

    function renderProducts(products, projectId) {
        if (products.length === 0) {
            return '<p style="color: var(--text-secondary); font-size: 13px; padding: 12px 0;">Nema proizvoda</p>';
        }

        return products.map(product => `
    <div class="product-card" data-id="${product.Product_ID}">
      <div class="product-header" onclick="toggleProduct('${product.Product_ID}')">
        <button class="expand-btn" id="expand-prod-${product.Product_ID}">
          <span class="material-icons-round">chevron_right</span>
        </button>
        <div class="product-info">
          <div class="product-name">${product.Name || 'Bez naziva'}</div>
          <div class="product-dims">${product.Height || 0} √ó ${product.Width || 0} √ó ${product.Depth || 0} mm | Qty: ${product.Quantity || 1}</div>
        </div>
        <div class="product-cost">${formatCurrency(product.Material_Cost)}</div>
        <span class="status-badge ${getStatusClass(product.Status)}">${product.Status || 'Na ƒçekanju'}</span>
        <div class="project-actions" onclick="event.stopPropagation()">
          <button class="icon-btn" onclick="editProduct('${product.Product_ID}')" title="Uredi">
            <span class="material-icons-round">edit</span>
          </button>
          <button class="icon-btn danger" onclick="confirmDeleteProduct('${product.Product_ID}')" title="Obri≈°i">
            <span class="material-icons-round">delete</span>
          </button>
        </div>
      </div>
      <div class="product-materials" id="materials-${product.Product_ID}">
        <div class="materials-header">
          <h5>Materijali (${(product.materials || []).length})</h5>
          <button class="btn btn-sm btn-secondary" onclick="openAddMaterialModal('${product.Product_ID}')">
            <span class="material-icons-round">add</span> Dodaj
          </button>
        </div>
        ${renderProductMaterials(product.materials || [])}
      </div>
    </div>
  `).join('');
    }

    function renderProductMaterials(materials) {
        if (materials.length === 0) {
            return '<p style="color: var(--text-secondary); font-size: 12px; margin-left: 32px;">Nema materijala</p>';
        }

        return materials.map(m => {
            // Check if this is a glass material (has glassItems attached)
            const isGlass = m.glassItems && m.glassItems.length > 0;
            // Check if this is an alu door material (has aluDoorItems attached)
            const isAluDoor = m.aluDoorItems && m.aluDoorItems.length > 0;

            // Calculate total piece count for glass
            let glassCount = 0;
            if (isGlass) {
                m.glassItems.forEach(gi => {
                    glassCount += parseInt(gi.Qty) || 1;
                });
            }

            // Calculate total piece count for alu doors
            let aluDoorCount = 0;
            if (isAluDoor) {
                m.aluDoorItems.forEach(item => {
                    aluDoorCount += parseInt(item.Qty) || 1;
                });
            }

            // Build indicator based on type
            let indicator = '';
            let editButton = '';

            if (isGlass) {
                indicator = '<span class="material-glass-indicator">ü™ü ' + glassCount + ' kom</span>';
                editButton = '<button class="icon-btn" onclick="openGlassModalForEdit(\'' + m.ID + '\')" title="Uredi komade stakla"><span class="material-icons-round">edit</span></button>';
            } else if (isAluDoor) {
                indicator = '<span class="material-alu-door-indicator">üö™ ' + aluDoorCount + ' kom</span>';
                editButton = '<button class="icon-btn" onclick="openAluDoorModalForEdit(\'' + m.ID + '\')" title="Uredi alu vrata"><span class="material-icons-round">edit</span></button>';
            }

            return '\
    <div class="material-row">\
      <span class="material-name">\
        ' + (m.Material_Name || 'Nepoznato') + '\
        ' + indicator + '\
      </span>\
      <span class="material-qty">' + m.Quantity + ' ' + m.Unit + '</span>\
      <span class="material-price">' + formatCurrency(m.Unit_Price) + '</span>\
      <span class="material-total">' + formatCurrency(m.Total_Price) + '</span>\
      <span class="status-badge ' + getStatusClass(m.Status) + '">' + (m.Status || '') + '</span>\
      ' + editButton + '\
      <button class="icon-btn danger" onclick="confirmDeleteMaterial(\'' + m.ID + '\')" title="Obri≈°i">\
        <span class="material-icons-round">close</span>\
      </button>\
    </div>';
        }).join('');
    }

    function toggleProject(projectId) {
        const expandBtn = document.getElementById('expand-' + projectId);
        const productsDiv = document.getElementById('products-' + projectId);

        const isExpanding = !expandBtn.classList.contains('expanded');
        expandBtn.classList.toggle('expanded');
        productsDiv.classList.toggle('expanded');

        // Products are already loaded via getAllData - no backend call needed!
        if (isExpanding) {
            const project = appState.projects.find(p => p.Project_ID === projectId);
            if (project && project.products && project.products.length > 0) {
                // Products are already attached - just render them
                productsDiv.innerHTML = `
                    <div class="products-header">
                        <h4>Proizvodi (${project.products.length})</h4>
                        <button class="btn btn-sm btn-secondary" onclick="openProductModal('${projectId}')">
                            <span class="material-icons-round">add</span> Dodaj proizvod
                        </button>
                    </div>
                    ${renderProducts(project.products, projectId)}
                `;
            }
        }
    }

    function toggleProduct(productId) {
        const expandBtn = document.getElementById('expand-prod-' + productId);
        const materials = document.getElementById('materials-' + productId);

        expandBtn.classList.toggle('expanded');
        materials.classList.toggle('expanded');
    }

    function openProjectModal(project = null) {
        document.getElementById('project-modal-title').textContent = project ? 'Uredi Projekat' : 'Novi Projekat';
        document.getElementById('project-id').value = project?.Project_ID || '';
        document.getElementById('project-client').value = project?.Client_Name || '';
        document.getElementById('project-phone').value = project?.Client_Phone || '';
        document.getElementById('project-email').value = project?.Client_Email || '';
        document.getElementById('project-address').value = project?.Address || '';
        document.getElementById('project-mode').value = project?.Production_Mode || 'PreCut';
        document.getElementById('project-deadline').value = project?.Deadline ? new Date(project.Deadline).toISOString().split('T')[0] : '';
        document.getElementById('project-notes').value = project?.Notes || '';

        openModal('project-modal');
    }

    function editProject(projectId) {
        const project = appState.projects.find(p => p.Project_ID === projectId);
        if (project) {
            openProjectModal(project);
        }
    }

    function saveProject() {
        const data = {
            Project_ID: document.getElementById('project-id').value || null,
            Client_Name: document.getElementById('project-client').value,
            Client_Phone: document.getElementById('project-phone').value,
            Client_Email: document.getElementById('project-email').value,
            Address: document.getElementById('project-address').value,
            Production_Mode: document.getElementById('project-mode').value,
            Deadline: document.getElementById('project-deadline').value,
            Notes: document.getElementById('project-notes').value
        };

        if (!data.Client_Name) {
            showToast('Unesite ime klijenta', 'error');
            return;
        }

        showLoading();
        google.script.run
            .withSuccessHandler(result => {
                hideLoading();
                if (result.success) {
                    showToast(result.message, 'success');
                    closeModal();

                    // Update local state instead of full reload
                    if (data.Project_ID) {
                        // Update existing project
                        const idx = appState.projects.findIndex(p => p.Project_ID === data.Project_ID);
                        if (idx >= 0) {
                            appState.projects[idx] = { ...appState.projects[idx], ...data };
                        }
                    } else {
                        // Add new project
                        const newProject = { ...data, Project_ID: result.data?.Project_ID || generateTempId(), products: [] };
                        appState.projects.push(newProject);
                    }
                    renderProjects();
                } else {
                    showToast(result.error, 'error');
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showToast('Gre≈°ka: ' + err.message, 'error');
            })
            .saveProject(data);
    }

    // Generate temporary ID for optimistic updates
    function generateTempId() {
        return 'temp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }

    function confirmDeleteProject(projectId) {
        if (confirm('Jeste li sigurni da ≈æelite obrisati ovaj projekat i sve njegove proizvode?')) {
            // Optimistic delete - remove from UI immediately
            appState.projects = appState.projects.filter(p => p.Project_ID !== projectId);
            renderProjects();
            showToast('Projekat obrisan', 'success');

            // Delete in background
            google.script.run
                .withFailureHandler(err => {
                    console.error('Delete failed:', err);
                    loadAllData(); // Restore on failure
                })
                .deleteProject(projectId);
        }
    }

    // ============================================
    // PRODUCTS
    // ============================================
    function openProductModal(projectId, product = null) {
        document.getElementById('product-modal-title').textContent = product ? 'Uredi Proizvod' : 'Novi Proizvod';
        document.getElementById('product-id').value = product?.Product_ID || '';
        document.getElementById('product-project-id').value = projectId;
        document.getElementById('product-name').value = product?.Name || '';
        document.getElementById('product-height').value = product?.Height || '';
        document.getElementById('product-width').value = product?.Width || '';
        document.getElementById('product-depth').value = product?.Depth || '';
        document.getElementById('product-quantity').value = product?.Quantity || 1;
        document.getElementById('product-notes').value = product?.Notes || '';

        openModal('product-modal');
    }

    function editProduct(productId) {
        // Find product in projects
        for (const project of appState.projects) {
            const product = (project.products || []).find(p => p.Product_ID === productId);
            if (product) {
                openProductModal(project.Project_ID, product);
                return;
            }
        }
    }

    function saveProduct() {
        const data = {
            Product_ID: document.getElementById('product-id').value || null,
            Project_ID: document.getElementById('product-project-id').value,
            Name: document.getElementById('product-name').value,
            Height: parseFloat(document.getElementById('product-height').value) || 0,
            Width: parseFloat(document.getElementById('product-width').value) || 0,
            Depth: parseFloat(document.getElementById('product-depth').value) || 0,
            Quantity: parseInt(document.getElementById('product-quantity').value) || 1,
            Notes: document.getElementById('product-notes').value
        };

        if (!data.Name) {
            showToast('Unesite naziv proizvoda', 'error');
            return;
        }

        showLoading();
        google.script.run
            .withSuccessHandler(result => {
                hideLoading();
                if (result.success) {
                    showToast(result.message, 'success');
                    closeModal();

                    // Update local state
                    const project = appState.projects.find(p => p.Project_ID === data.Project_ID);
                    if (project) {
                        if (!project.products) project.products = [];
                        if (data.Product_ID) {
                            const idx = project.products.findIndex(p => p.Product_ID === data.Product_ID);
                            if (idx >= 0) {
                                project.products[idx] = { ...project.products[idx], ...data };
                            }
                        } else {
                            const newProduct = { ...data, Product_ID: result.data?.Product_ID || generateTempId(), materials: [] };
                            project.products.push(newProduct);
                        }
                    }
                    renderProjects();
                } else {
                    showToast(result.error, 'error');
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showToast('Gre≈°ka: ' + err.message, 'error');
            })
            .saveProduct(data);
    }

    function confirmDeleteProduct(productId) {
        if (confirm('Jeste li sigurni da ≈æelite obrisati ovaj proizvod?')) {
            // Optimistic delete
            appState.projects.forEach(project => {
                if (project.products) {
                    project.products = project.products.filter(p => p.Product_ID !== productId);
                }
            });
            renderProjects();
            showToast('Proizvod obrisan', 'success');

            // Delete in background
            google.script.run
                .withFailureHandler(err => {
                    console.error('Delete failed:', err);
                    loadAllData();
                })
                .deleteProduct(productId);
        }
    }

    // ============================================
    // MATERIALS (Add to Product) - Fuzzy Search
    // ============================================

    // Material search state
    let materialSearchState = {
        selectedMaterial: null,
        highlightedIndex: -1,
        filteredMaterials: []
    };

    /**
     * Fuzzy search function - matches words in any order, partial matches allowed
     * @param {string} query - Search query
     * @param {string} text - Text to search in
     * @returns {object} { matches: boolean, score: number, highlighted: string }
     */
    function fuzzyMatch(query, text) {
        if (!query || !text) return { matches: true, score: 0, highlighted: text };

        // Normalize: lowercase, remove special characters
        const normalize = (str) => str
            .toLowerCase()
            .replace(/[ƒçƒá]/g, 'c')
            .replace(/[≈°≈ü]/g, 's')
            .replace(/[≈æ≈º]/g, 'z')
            .replace(/ƒë/g, 'd')
            .replace(/[¬∞'"‚Ä≥√óx]/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();

        const normalizedQuery = normalize(query);
        const normalizedText = normalize(text);
        const originalText = text;

        // Split query into tokens
        const queryTokens = normalizedQuery.split(' ').filter(t => t.length > 0);

        if (queryTokens.length === 0) {
            return { matches: true, score: 0, highlighted: originalText };
        }

        let score = 0;
        let matchedTokens = 0;
        let highlightPositions = [];

        // For each query token, find matches in text
        for (const token of queryTokens) {
            let found = false;

            // Check if token appears anywhere in the normalized text
            let searchStart = 0;
            while (true) {
                const pos = normalizedText.indexOf(token, searchStart);
                if (pos === -1) break;

                found = true;
                // Higher score for word-start matches
                if (pos === 0 || normalizedText[pos - 1] === ' ') {
                    score += 10;
                } else {
                    score += 5;
                }

                // Track position for highlighting (in original text)
                // Find original position by mapping through normalization
                let origPos = 0;
                let normPos = 0;
                const tempNorm = normalize(originalText.substring(0, originalText.length));

                // Simple approach: find position in original by searching for the part
                const lowerOriginal = originalText.toLowerCase();
                const tokenInOriginal = lowerOriginal.indexOf(token.toLowerCase(), searchStart);
                if (tokenInOriginal >= 0) {
                    highlightPositions.push({ start: tokenInOriginal, end: tokenInOriginal + token.length });
                }

                searchStart = pos + 1;
            }

            if (found) {
                matchedTokens++;
            }
        }

        // All tokens must match for it to be a valid result
        const matches = matchedTokens === queryTokens.length;

        // Bonus for exact match
        if (normalizedText === normalizedQuery) {
            score += 100;
        }

        // Generate highlighted text
        let highlighted = originalText;
        if (matches && highlightPositions.length > 0) {
            // Sort positions by start, then merge overlapping
            highlightPositions.sort((a, b) => a.start - b.start);
            const merged = [];
            for (const pos of highlightPositions) {
                if (merged.length === 0 || pos.start > merged[merged.length - 1].end) {
                    merged.push({ ...pos });
                } else {
                    merged[merged.length - 1].end = Math.max(merged[merged.length - 1].end, pos.end);
                }
            }

            // Build highlighted string from end to start (so positions remain valid)
            for (let i = merged.length - 1; i >= 0; i--) {
                const { start, end } = merged[i];
                highlighted = highlighted.substring(0, start) +
                    '<mark>' + highlighted.substring(start, end) + '</mark>' +
                    highlighted.substring(end);
            }
        }

        return { matches, score, highlighted };
    }

    function openAddMaterialModal(productId) {
        const productIdInput = document.getElementById('material-product-id');
        const searchInput = document.getElementById('material-search');
        const selectInput = document.getElementById('material-select');
        const quantityInput = document.getElementById('material-quantity');
        const unitInput = document.getElementById('material-unit');
        const priceInput = document.getElementById('material-price');
        const totalDisplay = document.getElementById('material-total');

        if (productIdInput) productIdInput.value = productId;

        // Reset search state
        materialSearchState = {
            selectedMaterial: null,
            highlightedIndex: -1,
            filteredMaterials: [...appState.materials]
        };

        // Clear form
        if (searchInput) searchInput.value = '';
        if (selectInput) selectInput.value = '';
        if (quantityInput) quantityInput.value = '';
        if (unitInput) unitInput.value = '';
        if (priceInput) priceInput.value = '';
        if (totalDisplay) totalDisplay.textContent = '0.00 KM';

        // Render initial options (show all)
        renderMaterialDropdown('');

        openModal('add-material-modal');

        // Focus search input after modal opens
        setTimeout(() => {
            const input = document.getElementById('material-search');
            if (input) input.focus();
        }, 100);
    }

    function renderMaterialDropdown(query) {
        const dropdown = document.getElementById('material-dropdown');
        if (!dropdown) return;

        // Filter and score materials
        const results = appState.materials.map(m => {
            const result = fuzzyMatch(query, m.Name);
            return {
                material: m,
                ...result
            };
        }).filter(r => r.matches);

        // Sort by score (highest first)
        results.sort((a, b) => b.score - a.score);

        // Take top 50 results for performance
        const topResults = results.slice(0, 50);
        materialSearchState.filteredMaterials = topResults.map(r => r.material);
        materialSearchState.highlightedIndex = topResults.length > 0 ? 0 : -1;

        if (topResults.length === 0) {
            dropdown.innerHTML = `
                <div class="searchable-no-results">
                    <span class="material-icons-round">search_off</span>
                    Nema rezultata za "${query}"
                </div>
            `;
            return;
        }

        dropdown.innerHTML = topResults.map((r, idx) => `
            <div class="searchable-option ${idx === 0 ? 'highlighted' : ''}" 
                 data-material-id="${r.material.Material_ID}"
                 data-unit="${r.material.Unit || 'kom'}"
                 data-price="${r.material.Default_Unit_Price || 0}"
                 onclick="selectMaterial('${r.material.Material_ID}')">
                <span class="searchable-option-name">${r.highlighted}</span>
                <span class="searchable-option-meta">${r.material.Category || ''} | ${r.material.Unit || 'kom'} | ${formatCurrency(r.material.Default_Unit_Price || 0)}</span>
            </div>
        `).join('');
    }

    function selectMaterial(materialId) {
        const material = appState.materials.find(m => m.Material_ID === materialId);
        if (!material) return;

        materialSearchState.selectedMaterial = material;

        // Update UI with null checks
        const searchInput = document.getElementById('material-search');
        const selectInput = document.getElementById('material-select');
        const unitInput = document.getElementById('material-unit');
        const priceInput = document.getElementById('material-price');
        const dropdown = document.getElementById('material-dropdown');
        const quantityInput = document.getElementById('material-quantity');

        if (searchInput) searchInput.value = material.Name;
        if (selectInput) selectInput.value = materialId;
        if (unitInput) unitInput.value = material.Unit || 'kom';
        if (priceInput) priceInput.value = material.Default_Unit_Price || '';

        // Hide dropdown
        if (dropdown) dropdown.classList.remove('active');

        // Calculate total
        calculateMaterialTotal();

        // Focus quantity input
        if (quantityInput) quantityInput.focus();
    }

    // Initialize material search event listeners
    function initMaterialSearch() {
        const searchInput = document.getElementById('material-search');
        const dropdown = document.getElementById('material-dropdown');

        if (!searchInput || !dropdown) return;

        // Search input handler
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            renderMaterialDropdown(query);
            dropdown.classList.add('active');

            // Clear selection if typing
            if (materialSearchState.selectedMaterial &&
                query !== materialSearchState.selectedMaterial.Name) {
                materialSearchState.selectedMaterial = null;
                document.getElementById('material-select').value = '';
            }
        });

        // Focus handler - show dropdown
        searchInput.addEventListener('focus', () => {
            renderMaterialDropdown(searchInput.value.trim());
            dropdown.classList.add('active');
        });

        // Keyboard navigation
        searchInput.addEventListener('keydown', (e) => {
            const options = dropdown.querySelectorAll('.searchable-option');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                materialSearchState.highlightedIndex = Math.min(
                    materialSearchState.highlightedIndex + 1,
                    options.length - 1
                );
                updateHighlightedOption(options);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                materialSearchState.highlightedIndex = Math.max(
                    materialSearchState.highlightedIndex - 1,
                    0
                );
                updateHighlightedOption(options);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (materialSearchState.highlightedIndex >= 0 &&
                    materialSearchState.filteredMaterials[materialSearchState.highlightedIndex]) {
                    selectMaterial(materialSearchState.filteredMaterials[materialSearchState.highlightedIndex].Material_ID);
                }
            } else if (e.key === 'Escape') {
                dropdown.classList.remove('active');
            }
        });

        // Click outside to close
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.searchable-select')) {
                dropdown.classList.remove('active');
            }
        });
    }

    function updateHighlightedOption(options) {
        options.forEach((opt, idx) => {
            opt.classList.toggle('highlighted', idx === materialSearchState.highlightedIndex);
        });

        // Scroll highlighted option into view
        if (options[materialSearchState.highlightedIndex]) {
            options[materialSearchState.highlightedIndex].scrollIntoView({
                block: 'nearest',
                behavior: 'smooth'
            });
        }
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', initMaterialSearch);
    // Also try to init immediately if DOM already loaded
    if (document.readyState !== 'loading') {
        initMaterialSearch();
    }

    function calculateMaterialTotal() {
        const qty = parseFloat(document.getElementById('material-quantity').value) || 0;
        const price = parseFloat(document.getElementById('material-price').value) || 0;
        document.getElementById('material-total').textContent = formatCurrency(qty * price);
    }

    // Add event listener for quantity change
    document.getElementById('material-quantity')?.addEventListener('input', calculateMaterialTotal);
    document.getElementById('material-price')?.addEventListener('input', calculateMaterialTotal);

    // ============================================
    // GLASS MATERIALS
    // ============================================

    // Glass state for current modal
    let glassState = {
        productId: null,
        materialId: null,
        materialName: '',
        supplier: '',
        pricePerM2: 0,
        items: [] // Array of {Qty, Width, Height, Edge_Processing, Note}
    };

    function openGlassModal(productId, materialId, materialName, supplier, pricePerM2) {
        glassState = {
            productId: productId,
            materialId: materialId,
            materialName: materialName,
            supplier: supplier || '',
            pricePerM2: parseFloat(pricePerM2) || 0,
            items: [],
            isEditMode: false,
            productMaterialId: null
        };

        // Populate modal info
        document.getElementById('glass-product-id').value = productId;
        document.getElementById('glass-material-id').value = materialId;
        document.getElementById('glass-material-name').textContent = materialName;
        document.getElementById('glass-price-m2').textContent = formatCurrency(glassState.pricePerM2);
        document.getElementById('glass-supplier').textContent = supplier || '-';
        document.getElementById('glass-modal-title').textContent = 'ü™ü Dodaj Staklo';

        // Add one empty row by default
        addGlassItemRow();

        // Show modal
        document.getElementById('glass-modal').classList.add('active');
        document.getElementById('modal-overlay').classList.add('active');
    }

    function closeGlassModal() {
        document.getElementById('glass-modal').classList.remove('active');
        document.getElementById('modal-overlay').classList.remove('active');
        glassState = {
            productId: null,
            materialId: null,
            materialName: '',
            supplier: '',
            pricePerM2: 0,
            items: []
        };
    }

    function addGlassItemRow() {
        glassState.items.push({
            Qty: 1,
            Width: '',
            Height: '',
            Edge_Processing: true, // Default to edge processing
            Note: ''
        });
        renderGlassItems();
    }

    function removeGlassItemRow(index) {
        glassState.items.splice(index, 1);
        renderGlassItems();
        calculateGlassTotals();
    }

    function updateGlassItem(index, field, value) {
        if (field === 'Edge_Processing') {
            glassState.items[index][field] = value;
        } else if (field === 'Width' || field === 'Height') {
            glassState.items[index][field] = parseFloat(value) || 0;
        } else if (field === 'Qty') {
            glassState.items[index][field] = parseInt(value) || 1;
        } else {
            glassState.items[index][field] = value;
        }
        calculateGlassTotals();
    }

    function calculateGlassTotals() {
        let totalCount = 0;
        let totalArea = 0;
        let totalPrice = 0;

        glassState.items.forEach((item, index) => {
            const qty = parseInt(item.Qty) || 1;
            const width = parseFloat(item.Width) || 0;
            const height = parseFloat(item.Height) || 0;

            if (width > 0 && height > 0) {
                const areaPerPiece = (width * height) / 1000000; // mm¬≤ to m¬≤
                const areaTotal = areaPerPiece * qty;
                const hasEdge = item.Edge_Processing === true;
                const price = areaTotal * glassState.pricePerM2 * (hasEdge ? 1.10 : 1);

                totalCount += qty;
                totalArea += areaTotal;
                totalPrice += price;

                // Update the row display
                const areaCell = document.getElementById(`glass-area-${index}`);
                const priceCell = document.getElementById(`glass-price-${index}`);
                if (areaCell) areaCell.textContent = areaTotal.toFixed(4);
                if (priceCell) priceCell.textContent = formatCurrency(price);
            }
        });

        document.getElementById('glass-total-count').textContent = totalCount;
        document.getElementById('glass-total-area').textContent = totalArea.toFixed(2) + ' m¬≤';
        document.getElementById('glass-total-price').textContent = formatCurrency(totalPrice);
    }

    function renderGlassItems() {
        const tbody = document.getElementById('glass-items-body');

        if (glassState.items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: var(--text-secondary);">Kliknite "Dodaj komad" za unos stakla</td></tr>';
            return;
        }

        tbody.innerHTML = glassState.items.map((item, index) => {
            const qty = parseInt(item.Qty) || 1;
            const width = parseFloat(item.Width) || 0;
            const height = parseFloat(item.Height) || 0;
            const areaPerPiece = width > 0 && height > 0 ? (width * height) / 1000000 : 0;
            const areaTotal = areaPerPiece * qty;
            const hasEdge = item.Edge_Processing === true;
            const price = areaTotal * glassState.pricePerM2 * (hasEdge ? 1.10 : 1);

            return `
                <tr>
                    <td class="cell-centered">${index + 1}</td>
                    <td>
                        <input type="number" value="${qty}" min="1" step="1" 
                            style="width: 60px;" onchange="updateGlassItem(${index}, 'Qty', this.value)">
                    </td>
                    <td>
                        <input type="number" value="${item.Width || ''}" min="0" step="1" 
                            placeholder="mm" onchange="updateGlassItem(${index}, 'Width', this.value)">
                    </td>
                    <td>
                        <input type="number" value="${item.Height || ''}" min="0" step="1" 
                            placeholder="mm" onchange="updateGlassItem(${index}, 'Height', this.value)">
                    </td>
                    <td class="cell-centered">
                        <input type="checkbox" ${hasEdge ? 'checked' : ''} 
                            onchange="updateGlassItem(${index}, 'Edge_Processing', this.checked)">
                    </td>
                    <td class="cell-readonly" id="glass-area-${index}">${areaTotal.toFixed(4)}</td>
                    <td class="cell-readonly" id="glass-price-${index}">${formatCurrency(price)}</td>
                    <td>
                        <input type="text" value="${item.Note || ''}" placeholder="..." 
                            onchange="updateGlassItem(${index}, 'Note', this.value)">
                    </td>
                    <td class="cell-centered">
                        <button type="button" class="btn-delete-row" onclick="removeGlassItemRow(${index})">
                            <span class="material-icons-round">delete</span>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function saveGlassMaterial() {
        // Validate - need at least one item with dimensions
        const validItems = glassState.items.filter(item => {
            const width = parseFloat(item.Width) || 0;
            const height = parseFloat(item.Height) || 0;
            return width > 0 && height > 0;
        });

        if (validItems.length === 0) {
            showToast('Unesite bar jedan komad stakla sa dimenzijama', 'error');
            return;
        }

        const data = {
            productId: glassState.productId,
            materialId: glassState.materialId,
            materialName: glassState.materialName,
            supplier: glassState.supplier,
            unitPrice: glassState.pricePerM2,
            items: validItems.map(item => ({
                Qty: parseInt(item.Qty) || 1,
                Width: parseFloat(item.Width) || 0,
                Height: parseFloat(item.Height) || 0,
                Edge_Processing: item.Edge_Processing === true,
                Note: item.Note || ''
            }))
        };

        showLoading();

        // Check if this is an update or new add
        if (glassState.isEditMode && glassState.productMaterialId) {
            // Update existing
            data.productMaterialId = glassState.productMaterialId;
            google.script.run
                .withSuccessHandler(result => {
                    hideLoading();
                    if (result.success) {
                        showToast(`Staklo a≈æurirano: ${result.data.itemCount} komada, ${result.data.totalArea} m¬≤`, 'success');
                        closeGlassModal();
                        loadAllData();
                    } else {
                        showToast(result.error, 'error');
                    }
                })
                .withFailureHandler(err => {
                    hideLoading();
                    showToast('Gre≈°ka: ' + err.message, 'error');
                })
                .updateGlassMaterial(data);
        } else {
            // Add new
            google.script.run
                .withSuccessHandler(result => {
                    hideLoading();
                    if (result.success) {
                        showToast(`Staklo dodano: ${result.data.itemCount} komada, ${result.data.totalArea} m¬≤`, 'success');
                        closeGlassModal();
                        loadAllData();
                    } else {
                        showToast(result.error, 'error');
                    }
                })
                .withFailureHandler(err => {
                    hideLoading();
                    showToast('Gre≈°ka: ' + err.message, 'error');
                })
                .addGlassMaterialToProduct(data);
        }
    }

    // Open glass modal for editing existing glass material
    function openGlassModalForEdit(productMaterialId) {
        // Find the product material in appState
        let productMaterial = null;
        let product = null;

        for (const project of appState.projects) {
            for (const prod of (project.products || [])) {
                const pm = (prod.materials || []).find(m => m.ID === productMaterialId);
                if (pm) {
                    productMaterial = pm;
                    product = prod;
                    break;
                }
            }
            if (productMaterial) break;
        }

        if (!productMaterial) {
            showToast('Materijal nije pronaƒëen', 'error');
            return;
        }

        // Find material info
        const material = appState.materials.find(m => m.Material_ID === productMaterial.Material_ID);

        glassState = {
            productId: product?.Product_ID,
            productMaterialId: productMaterialId,
            materialId: productMaterial.Material_ID,
            materialName: productMaterial.Material_Name,
            supplier: productMaterial.Supplier || '',
            pricePerM2: parseFloat(productMaterial.Unit_Price) || 0,
            items: [],
            isEditMode: true
        };

        // Populate modal info
        document.getElementById('glass-product-id').value = glassState.productId;
        document.getElementById('glass-material-id').value = glassState.materialId;
        document.getElementById('glass-material-name').textContent = glassState.materialName;
        document.getElementById('glass-price-m2').textContent = formatCurrency(glassState.pricePerM2);
        document.getElementById('glass-supplier').textContent = glassState.supplier || '-';
        document.getElementById('glass-modal-title').textContent = 'ü™ü Uredi Staklo';

        // Load existing glass items
        if (productMaterial.glassItems && productMaterial.glassItems.length > 0) {
            glassState.items = productMaterial.glassItems.map(gi => ({
                Qty: parseInt(gi.Qty) || 1,
                Width: gi.Width,
                Height: gi.Height,
                Edge_Processing: gi.Edge_Processing === true || gi.Edge_Processing === 'true',
                Note: gi.Note || ''
            }));
        } else {
            // No existing items, add empty row
            glassState.items.push({
                Qty: 1,
                Width: '',
                Height: '',
                Edge_Processing: true,
                Note: ''
            });
        }

        renderGlassItems();
        calculateGlassTotals();

        // Show modal
        document.getElementById('glass-modal').classList.add('active');
        document.getElementById('modal-overlay').classList.add('active');
    }

    // Modified onMaterialSelect to check for glass
    function checkIfGlassMaterial() {
        const materialId = document.getElementById('material-select')?.value;
        if (!materialId) return false;

        const material = appState.materials.find(m => m.Material_ID === materialId);
        return material && (material.Is_Glass === true || material.Is_Glass === 'true' || material.Is_Glass === 'TRUE' || material.Category === 'Staklo');
    }

    function addMaterialToProduct() {
        const materialId = document.getElementById('material-select')?.value;

        if (!materialId) {
            showToast('Odaberite materijal', 'error');
            return;
        }

        // Get material from state or find it
        const material = materialSearchState.selectedMaterial ||
            appState.materials.find(m => m.Material_ID === materialId);

        if (!material) {
            showToast('Materijal nije pronaƒëen', 'error');
            return;
        }

        // Check if this is a glass material - redirect to glass modal
        if (material.Is_Glass === true || material.Is_Glass === 'true' || material.Is_Glass === 'TRUE' || material.Category === 'Staklo') {
            const productId = document.getElementById('material-product-id')?.value;
            closeModal(); // Close the standard material modal
            openGlassModal(productId, material.Material_ID, material.Name, material.Default_Supplier, material.Default_Unit_Price);
            return;
        }

        // Check if this is an alu door material - redirect to alu door modal
        if (material.Is_Alu_Door === true || material.Is_Alu_Door === 'true' || material.Is_Alu_Door === 'TRUE' || material.Category === 'Alu vrata') {
            const productId = document.getElementById('material-product-id')?.value;
            closeModal(); // Close the standard material modal
            openAluDoorModal(productId, material.Material_ID, material.Name, material.Default_Supplier, material.Default_Unit_Price || 200);
            return;
        }

        const data = {
            Product_ID: document.getElementById('material-product-id')?.value,
            Material_ID: materialId,
            Material_Name: material.Name,
            Quantity: parseFloat(document.getElementById('material-quantity')?.value) || 0,
            Unit: document.getElementById('material-unit')?.value,
            Unit_Price: parseFloat(document.getElementById('material-price')?.value) || 0
        };

        if (!data.Quantity || data.Quantity <= 0) {
            showToast('Unesite koliƒçinu', 'error');
            return;
        }

        showLoading();
        google.script.run
            .withSuccessHandler(result => {
                hideLoading();
                if (result.success) {
                    showToast('Materijal dodan', 'success');
                    closeModal();
                    loadAllData();
                } else {
                    showToast(result.error, 'error');
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showToast('Gre≈°ka: ' + err.message, 'error');
            })
            .addMaterialToProduct(data);
    }

    function confirmDeleteMaterial(materialId) {
        if (confirm('Obrisati ovaj materijal?')) {
            showLoading();
            google.script.run
                .withSuccessHandler(result => {
                    hideLoading();
                    if (result.success) {
                        showToast('Materijal obrisan', 'success');
                        loadAllData();
                    }
                })
                .withFailureHandler(err => {
                    hideLoading();
                    showToast('Gre≈°ka: ' + err.message, 'error');
                })
                .deleteProductMaterial(materialId);
        }
    }

    // ============================================
    // ALU DOOR MATERIALS
    // ============================================

    // Alu door state for current modal
    let aluDoorState = {
        productId: null,
        materialId: null,
        materialName: '',
        supplier: '',
        pricePerM2: 200,
        items: [], // Array of door configs
        isEditMode: false,
        productMaterialId: null
    };

    // Configuration options
    const GLASS_TYPES = ['float', 'bronza', 'flutes', 'gray', 'dark gray', 'mlijeƒçno', 'satinato'];
    const FRAME_TYPES = ['uski', '≈°iroki'];
    const HINGE_TYPES = ['ravne', 'krive', 'polukrive'];
    const HINGE_SIDES = ['lijevo', 'desno'];
    const HINGE_LAYOUTS = ['osnovna', 'specijalna'];

    function openAluDoorModal(productId, materialId, materialName, supplier, pricePerM2) {
        aluDoorState = {
            productId: productId,
            materialId: materialId,
            materialName: materialName,
            supplier: supplier || '',
            pricePerM2: parseFloat(pricePerM2) || 200,
            items: [],
            isEditMode: false,
            productMaterialId: null
        };

        // Populate modal info
        document.getElementById('alu-door-product-id').value = productId;
        document.getElementById('alu-door-material-id').value = materialId;
        document.getElementById('alu-door-material-name').textContent = materialName;
        document.getElementById('alu-door-price-m2').textContent = formatCurrency(aluDoorState.pricePerM2);
        document.getElementById('alu-door-supplier').textContent = supplier || '-';
        document.getElementById('alu-door-modal-title').textContent = 'üö™ Dodaj Alu Vrata';

        // Add one empty row by default
        addAluDoorItemRow();

        // Show modal
        document.getElementById('alu-door-modal').classList.add('active');
        document.getElementById('modal-overlay').classList.add('active');
    }

    function closeAluDoorModal() {
        document.getElementById('alu-door-modal').classList.remove('active');
        document.getElementById('modal-overlay').classList.remove('active');
        aluDoorState = {
            productId: null,
            materialId: null,
            materialName: '',
            supplier: '',
            pricePerM2: 200,
            items: []
        };
    }

    function addAluDoorItemRow() {
        aluDoorState.items.push({
            Qty: 1,
            Width: '',
            Height: '',
            Frame_Type: 'uski',
            Glass_Type: 'float',
            Frame_Color: '',
            Hinge_Color: '',
            Hinge_Type: 'ravne',
            Hinge_Side: 'lijevo',
            Hinge_Layout: 'osnovna',
            Hinge_Positions: [], // Array of positions from bottom in mm
            Integrated_Handle: false,
            Note: ''
        });
        renderAluDoorItems();
        calculateAluDoorTotals();
    }

    function removeAluDoorItemRow(index) {
        aluDoorState.items.splice(index, 1);
        renderAluDoorItems();
        calculateAluDoorTotals();
    }

    function updateAluDoorItem(index, field, value) {
        if (field === 'Integrated_Handle') {
            aluDoorState.items[index][field] = value;
        } else if (field === 'Width' || field === 'Height') {
            aluDoorState.items[index][field] = parseFloat(value) || 0;
        } else if (field === 'Qty') {
            aluDoorState.items[index][field] = parseInt(value) || 1;
        } else if (field === 'Hinge_Layout') {
            aluDoorState.items[index][field] = value;
            // If switching to specijalna and no positions, add first one
            if (value === 'specijalna' && aluDoorState.items[index].Hinge_Positions.length === 0) {
                aluDoorState.items[index].Hinge_Positions.push('');
            }
            renderAluDoorItems(); // Re-render to show/hide hinge position fields
        } else {
            aluDoorState.items[index][field] = value;
        }
        calculateAluDoorTotals();
    }

    function addHingePosition(doorIndex) {
        aluDoorState.items[doorIndex].Hinge_Positions.push('');
        renderAluDoorItems();
    }

    function removeHingePosition(doorIndex, hingeIndex) {
        aluDoorState.items[doorIndex].Hinge_Positions.splice(hingeIndex, 1);
        renderAluDoorItems();
    }

    function updateHingePosition(doorIndex, hingeIndex, value) {
        aluDoorState.items[doorIndex].Hinge_Positions[hingeIndex] = parseFloat(value) || '';
    }

    function calculateAluDoorTotals() {
        let totalCount = 0;
        let totalArea = 0;
        let totalPrice = 0;

        aluDoorState.items.forEach((item, index) => {
            const qty = parseInt(item.Qty) || 1;
            const width = parseFloat(item.Width) || 0;
            const height = parseFloat(item.Height) || 0;

            if (width > 0 && height > 0) {
                const areaPerPiece = (width * height) / 1000000; // mm¬≤ to m¬≤
                const areaTotal = areaPerPiece * qty;
                const price = areaTotal * aluDoorState.pricePerM2;

                totalCount += qty;
                totalArea += areaTotal;
                totalPrice += price;
            }
        });

        document.getElementById('alu-door-total-count').textContent = totalCount;
        document.getElementById('alu-door-total-area').textContent = totalArea.toFixed(2) + ' m¬≤';
        document.getElementById('alu-door-total-price').textContent = formatCurrency(totalPrice);
    }

    function renderAluDoorItems() {
        const container = document.getElementById('alu-door-items-body');

        if (aluDoorState.items.length === 0) {
            container.innerHTML = `
                <div class="alu-door-empty-state">
                    <span class="material-icons-round">door_front</span>
                    <p>Kliknite "Dodaj vrata" za unos novih vrata</p>
                </div>
            `;
            return;
        }

        container.innerHTML = aluDoorState.items.map((item, index) => {
            const qty = parseInt(item.Qty) || 1;
            const width = parseFloat(item.Width) || 0;
            const height = parseFloat(item.Height) || 0;
            const areaPerPiece = width > 0 && height > 0 ? (width * height) / 1000000 : 0;
            const areaTotal = areaPerPiece * qty;
            const price = areaTotal * aluDoorState.pricePerM2;

            // Generate options for dropdowns
            const glassOptions = GLASS_TYPES.map(g => `<option value="${g}" ${item.Glass_Type === g ? 'selected' : ''}>${g}</option>`).join('');
            const frameOptions = FRAME_TYPES.map(f => `<option value="${f}" ${item.Frame_Type === f ? 'selected' : ''}>${f}</option>`).join('');
            const hingeTypeOptions = HINGE_TYPES.map(h => `<option value="${h}" ${item.Hinge_Type === h ? 'selected' : ''}>${h}</option>`).join('');
            const hingeSideOptions = HINGE_SIDES.map(s => `<option value="${s}" ${item.Hinge_Side === s ? 'selected' : ''}>${s}</option>`).join('');
            const hingeLayoutOptions = HINGE_LAYOUTS.map(l => `<option value="${l}" ${item.Hinge_Layout === l ? 'selected' : ''}>${l}</option>`).join('');

            // Render hinge positions if specijalna
            let hingePositionsHtml = '';
            if (item.Hinge_Layout === 'specijalna') {
                const positionsHtml = (item.Hinge_Positions || []).map((pos, hIndex) => `
                    <div class="alu-door-hinge-position-item">
                        <label>Baglama ${hIndex + 1}:</label>
                        <input type="number" value="${pos}" placeholder="mm" min="0" 
                            onchange="updateHingePosition(${index}, ${hIndex}, this.value)">
                        <button type="button" class="btn-remove-hinge" onclick="removeHingePosition(${index}, ${hIndex})">
                            <span class="material-icons-round">close</span>
                        </button>
                    </div>
                `).join('');

                hingePositionsHtml = `
                    <div class="alu-door-hinge-section">
                        <div class="alu-door-section-title">Pozicije baglama (od dna u mm)</div>
                        <div class="alu-door-hinge-positions">
                            ${positionsHtml || '<span style="color: var(--text-tertiary); font-size: 12px;">Dodajte pozicije baglama</span>'}
                        </div>
                        <button type="button" class="btn-add-hinge" onclick="addHingePosition(${index})">
                            <span class="material-icons-round">add</span>
                            Dodaj baglamu
                        </button>
                    </div>
                `;
            }

            return `
                <div class="alu-door-card">
                    <div class="alu-door-card-header">
                        <h4>
                            <span class="door-number">${index + 1}</span>
                            Vrata ${width > 0 && height > 0 ? `${width} √ó ${height} mm` : ''}
                        </h4>
                        <div class="alu-door-card-summary">
                            <span>Povr≈°ina: <strong>${areaTotal.toFixed(4)} m¬≤</strong></span>
                            <span>Cijena: <strong>${formatCurrency(price)}</strong></span>
                            <button type="button" class="btn-delete-door" onclick="removeAluDoorItemRow(${index})" title="Obri≈°i vrata">
                                <span class="material-icons-round">delete</span>
                            </button>
                        </div>
                    </div>
                    <div class="alu-door-card-body">
                        <!-- Dimensions Section -->
                        <div class="alu-door-section">
                            <div class="alu-door-section-title">üìê Dimenzije</div>
                            <div class="alu-door-section-grid">
                                <div class="alu-door-field">
                                    <label>Koliƒçina</label>
                                    <input type="number" value="${qty}" min="1" step="1" 
                                        onchange="updateAluDoorItem(${index}, 'Qty', this.value)">
                                </div>
                                <div class="alu-door-field">
                                    <label>≈†irina (mm)</label>
                                    <input type="number" value="${item.Width || ''}" min="0" step="1" placeholder="mm"
                                        onchange="updateAluDoorItem(${index}, 'Width', this.value)">
                                </div>
                                <div class="alu-door-field">
                                    <label>Visina (mm)</label>
                                    <input type="number" value="${item.Height || ''}" min="0" step="1" placeholder="mm"
                                        onchange="updateAluDoorItem(${index}, 'Height', this.value)">
                                </div>
                            </div>
                        </div>

                        <!-- Appearance Section -->
                        <div class="alu-door-section">
                            <div class="alu-door-section-title">üé® Izgled</div>
                            <div class="alu-door-section-grid">
                                <div class="alu-door-field">
                                    <label>Vrsta rama</label>
                                    <select onchange="updateAluDoorItem(${index}, 'Frame_Type', this.value)">
                                        ${frameOptions}
                                    </select>
                                </div>
                                <div class="alu-door-field">
                                    <label>Vrsta stakla</label>
                                    <select onchange="updateAluDoorItem(${index}, 'Glass_Type', this.value)">
                                        ${glassOptions}
                                    </select>
                                </div>
                                <div class="alu-door-field">
                                    <label>Boja rama</label>
                                    <input type="text" value="${item.Frame_Color || ''}" placeholder="Unesite boju..."
                                        onchange="updateAluDoorItem(${index}, 'Frame_Color', this.value)">
                                </div>
                                <div class="alu-door-field checkbox-field">
                                    <input type="checkbox" ${item.Integrated_Handle ? 'checked' : ''} 
                                        onchange="updateAluDoorItem(${index}, 'Integrated_Handle', this.checked)">
                                    <label>Integrisana ruƒçka</label>
                                </div>
                            </div>
                        </div>

                        <!-- Hinges Section -->
                        <div class="alu-door-section">
                            <div class="alu-door-section-title">üî© Baglame</div>
                            <div class="alu-door-section-grid">
                                <div class="alu-door-field">
                                    <label>Tip baglama</label>
                                    <select onchange="updateAluDoorItem(${index}, 'Hinge_Type', this.value)">
                                        ${hingeTypeOptions}
                                    </select>
                                </div>
                                <div class="alu-door-field">
                                    <label>Boja baglama</label>
                                    <input type="text" value="${item.Hinge_Color || ''}" placeholder="Unesite boju..."
                                        onchange="updateAluDoorItem(${index}, 'Hinge_Color', this.value)">
                                </div>
                                <div class="alu-door-field">
                                    <label>Strana baglama</label>
                                    <select onchange="updateAluDoorItem(${index}, 'Hinge_Side', this.value)">
                                        ${hingeSideOptions}
                                    </select>
                                </div>
                                <div class="alu-door-field">
                                    <label>Raspored</label>
                                    <select onchange="updateAluDoorItem(${index}, 'Hinge_Layout', this.value)">
                                        ${hingeLayoutOptions}
                                    </select>
                                </div>
                            </div>
                            ${hingePositionsHtml}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function saveAluDoorMaterial() {
        // Validate - need at least one item with dimensions
        const validItems = aluDoorState.items.filter(item => {
            const width = parseFloat(item.Width) || 0;
            const height = parseFloat(item.Height) || 0;
            return width > 0 && height > 0;
        });

        if (validItems.length === 0) {
            showToast('Unesite bar jedna vrata sa dimenzijama', 'error');
            return;
        }

        const data = {
            productId: aluDoorState.productId,
            materialId: aluDoorState.materialId,
            materialName: aluDoorState.materialName,
            supplier: aluDoorState.supplier,
            unitPrice: aluDoorState.pricePerM2,
            items: validItems.map(item => ({
                Qty: parseInt(item.Qty) || 1,
                Width: parseFloat(item.Width) || 0,
                Height: parseFloat(item.Height) || 0,
                Frame_Type: item.Frame_Type || 'uski',
                Glass_Type: item.Glass_Type || 'float',
                Frame_Color: item.Frame_Color || '',
                Hinge_Color: item.Hinge_Color || '',
                Hinge_Type: item.Hinge_Type || 'ravne',
                Hinge_Side: item.Hinge_Side || 'lijevo',
                Hinge_Layout: item.Hinge_Layout || 'osnovna',
                Hinge_Positions: (item.Hinge_Positions || []).filter(p => p !== '' && p !== null).map(p => parseFloat(p) || 0),
                Integrated_Handle: item.Integrated_Handle === true,
                Note: item.Note || ''
            }))
        };

        showLoading();

        // Check if this is an update or new add
        if (aluDoorState.isEditMode && aluDoorState.productMaterialId) {
            // Update existing
            data.productMaterialId = aluDoorState.productMaterialId;
            google.script.run
                .withSuccessHandler(result => {
                    hideLoading();
                    if (result.success) {
                        showToast(`Alu vrata a≈æurirana: ${result.data.itemCount} komada, ${result.data.totalArea} m¬≤`, 'success');
                        closeAluDoorModal();
                        loadAllData();
                    } else {
                        showToast(result.error, 'error');
                    }
                })
                .withFailureHandler(err => {
                    hideLoading();
                    showToast('Gre≈°ka: ' + err.message, 'error');
                })
                .updateAluDoorMaterial(data);
        } else {
            // Add new
            google.script.run
                .withSuccessHandler(result => {
                    hideLoading();
                    if (result.success) {
                        showToast(`Alu vrata dodana: ${result.data.itemCount} komada, ${result.data.totalArea} m¬≤`, 'success');
                        closeAluDoorModal();
                        loadAllData();
                    } else {
                        showToast(result.error, 'error');
                    }
                })
                .withFailureHandler(err => {
                    hideLoading();
                    showToast('Gre≈°ka: ' + err.message, 'error');
                })
                .addAluDoorMaterialToProduct(data);
        }
    }

    // Open alu door modal for editing existing material
    function openAluDoorModalForEdit(productMaterialId) {
        // Find the product material in appState
        let productMaterial = null;
        let product = null;

        for (const project of appState.projects) {
            for (const prod of (project.products || [])) {
                const pm = (prod.materials || []).find(m => m.ID === productMaterialId);
                if (pm) {
                    productMaterial = pm;
                    product = prod;
                    break;
                }
            }
            if (productMaterial) break;
        }

        if (!productMaterial) {
            showToast('Materijal nije pronaƒëen', 'error');
            return;
        }

        // Find material info
        const material = appState.materials.find(m => m.Material_ID === productMaterial.Material_ID);

        aluDoorState = {
            productId: product?.Product_ID,
            productMaterialId: productMaterialId,
            materialId: productMaterial.Material_ID,
            materialName: productMaterial.Material_Name,
            supplier: productMaterial.Supplier || '',
            pricePerM2: parseFloat(productMaterial.Unit_Price) || 200,
            items: [],
            isEditMode: true
        };

        // Populate modal info
        document.getElementById('alu-door-product-id').value = aluDoorState.productId;
        document.getElementById('alu-door-material-id').value = aluDoorState.materialId;
        document.getElementById('alu-door-material-name').textContent = aluDoorState.materialName;
        document.getElementById('alu-door-price-m2').textContent = formatCurrency(aluDoorState.pricePerM2);
        document.getElementById('alu-door-supplier').textContent = aluDoorState.supplier || '-';
        document.getElementById('alu-door-modal-title').textContent = 'üö™ Uredi Alu Vrata';

        // Load existing alu door items
        if (productMaterial.aluDoorItems && productMaterial.aluDoorItems.length > 0) {
            aluDoorState.items = productMaterial.aluDoorItems.map(item => {
                // Parse Hinge_Positions - could be stored as JSON string or array
                let hingePositions = [];
                if (item.Hinge_Positions) {
                    if (typeof item.Hinge_Positions === 'string') {
                        try {
                            hingePositions = JSON.parse(item.Hinge_Positions);
                        } catch (e) {
                            hingePositions = [];
                        }
                    } else if (Array.isArray(item.Hinge_Positions)) {
                        hingePositions = item.Hinge_Positions;
                    }
                }

                return {
                    Qty: parseInt(item.Qty) || 1,
                    Width: item.Width,
                    Height: item.Height,
                    Frame_Type: item.Frame_Type || 'uski',
                    Glass_Type: item.Glass_Type || 'float',
                    Frame_Color: item.Frame_Color || '',
                    Hinge_Color: item.Hinge_Color || '',
                    Hinge_Type: item.Hinge_Type || 'ravne',
                    Hinge_Side: item.Hinge_Side || item.Hinge_Position || 'lijevo', // Backward compat
                    Hinge_Layout: item.Hinge_Layout || 'osnovna',
                    Hinge_Positions: hingePositions,
                    Integrated_Handle: item.Integrated_Handle === true || item.Integrated_Handle === 'true',
                    Note: item.Note || ''
                };
            });
        } else {
            // No existing items, add empty row
            aluDoorState.items.push({
                Qty: 1,
                Width: '',
                Height: '',
                Frame_Type: 'uski',
                Glass_Type: 'float',
                Frame_Color: '',
                Hinge_Color: '',
                Hinge_Type: 'ravne',
                Hinge_Side: 'lijevo',
                Hinge_Layout: 'osnovna',
                Hinge_Positions: [],
                Integrated_Handle: false,
                Note: ''
            });
        }

        renderAluDoorItems();
        calculateAluDoorTotals();

        // Show modal
        document.getElementById('alu-door-modal').classList.add('active');
        document.getElementById('modal-overlay').classList.add('active');
    }

    // Check if material is alu door type
    function checkIfAluDoorMaterial(materialId) {
        const material = appState.materials.find(m => m.Material_ID === materialId);
        return material && (material.Is_Alu_Door === true || material.Is_Alu_Door === 'true' || material.Is_Alu_Door === 'TRUE' || material.Category === 'Alu vrata');
    }

    // ============================================
    // MATERIALS DATABASE
    // ============================================
    function renderMaterials() {
        const container = document.getElementById('materials-list');
        const search = document.getElementById('materials-search').value.toLowerCase();
        const filter = document.getElementById('materials-filter').value;

        let filtered = appState.materials;

        if (search) {
            filtered = filtered.filter(m => m.Name?.toLowerCase().includes(search));
        }

        if (filter) {
            filtered = filtered.filter(m => m.Category === filter);
        }

        if (filtered.length === 0) {
            container.innerHTML = `
      <div class="empty-state">
        <span class="material-icons-round">inventory_2</span>
        <h3>Nema materijala</h3>
        <p>Dodajte materijale u bazu</p>
      </div>
    `;
            return;
        }

        container.innerHTML = filtered.map(m => `
    <div class="simple-card">
      <div class="simple-card-info">
        <div class="simple-card-title">${m.Name}</div>
        <div class="simple-card-subtitle">${m.Category || 'Nekategorizirano'} | ${m.Unit}</div>
      </div>
      <div class="simple-card-meta">
        <span class="simple-card-price">${formatCurrency(m.Default_Unit_Price)}/${m.Unit}</span>
        <button class="icon-btn" onclick="editMaterialDb('${m.Material_ID}')">
          <span class="material-icons-round">edit</span>
        </button>
        <button class="icon-btn danger" onclick="confirmDeleteMaterialDb('${m.Material_ID}')">
          <span class="material-icons-round">delete</span>
        </button>
      </div>
    </div>
  `).join('');
    }

    function openMaterialModal(material = null) {
        document.getElementById('material-modal-title').textContent = material ? 'Uredi Materijal' : 'Novi Materijal';
        document.getElementById('db-material-id').value = material?.Material_ID || '';
        document.getElementById('db-material-name').value = material?.Name || '';
        document.getElementById('db-material-category').value = material?.Category || 'Ploƒça';
        document.getElementById('db-material-unit').value = material?.Unit || 'kom';
        document.getElementById('db-material-price').value = material?.Default_Unit_Price || '';
        document.getElementById('db-material-desc').value = material?.Description || '';

        openModal('material-modal');
    }

    function editMaterialDb(materialId) {
        const material = appState.materials.find(m => m.Material_ID === materialId);
        if (material) {
            openMaterialModal(material);
        }
    }

    function saveMaterialDb() {
        const data = {
            Material_ID: document.getElementById('db-material-id').value || null,
            Name: document.getElementById('db-material-name').value,
            Category: document.getElementById('db-material-category').value,
            Unit: document.getElementById('db-material-unit').value,
            Default_Unit_Price: parseFloat(document.getElementById('db-material-price').value) || 0,
            Description: document.getElementById('db-material-desc').value
        };

        if (!data.Name) {
            showToast('Unesite naziv materijala', 'error');
            return;
        }

        showLoading();
        google.script.run
            .withSuccessHandler(result => {
                hideLoading();
                if (result.success) {
                    showToast(result.message, 'success');
                    closeModal();
                    loadAllData();
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showToast('Gre≈°ka: ' + err.message, 'error');
            })
            .saveMaterial(data);
    }

    function confirmDeleteMaterialDb(materialId) {
        if (confirm('Obrisati materijal iz baze?')) {
            showLoading();
            google.script.run
                .withSuccessHandler(result => {
                    hideLoading();
                    if (result.success) {
                        showToast('Materijal obrisan', 'success');
                        loadAllData();
                    }
                })
                .withFailureHandler(err => {
                    hideLoading();
                    showToast('Gre≈°ka: ' + err.message, 'error');
                })
                .deleteMaterial(materialId);
        }
    }

    // Search/filter event listeners for materials
    document.getElementById('materials-search')?.addEventListener('input', renderMaterials);
    document.getElementById('materials-filter')?.addEventListener('change', renderMaterials);

    // ============================================
    // OFFERS
    // ============================================
    function renderOffers() {
        const container = document.getElementById('offers-list');
        const search = document.getElementById('offers-search')?.value?.toLowerCase() || '';
        const filter = document.getElementById('offers-filter')?.value || '';

        let filtered = appState.offers;

        if (search) {
            filtered = filtered.filter(o =>
                o.Offer_Number?.toLowerCase().includes(search) ||
                o.Client_Name?.toLowerCase().includes(search)
            );
        }

        if (filter) {
            filtered = filtered.filter(o => o.Status === filter);
        }

        if (filtered.length === 0) {
            container.innerHTML = `
      <div class="empty-state">
        <span class="material-icons-round">request_quote</span>
        <h3>Nema ponuda</h3>
        <p>Kreirajte ponudu iz projekta</p>
      </div>
    `;
            return;
        }

        container.innerHTML = filtered.map(o => `
    <div class="simple-card">
      <div class="simple-card-info">
        <div class="simple-card-title">${o.Offer_Number} - ${o.Client_Name || 'Nepoznat klijent'}</div>
        <div class="simple-card-subtitle">Kreirano: ${formatDate(o.Created_Date)}</div>
      </div>
      <div class="simple-card-meta">
        <span class="status-badge ${getStatusClass(o.Status)}">${o.Status || 'Nacrt'}</span>
        <span class="simple-card-price">${formatCurrency(o.Total)}</span>
        <button class="icon-btn" onclick="viewOffer('${o.Offer_ID}')" title="Pregledaj">
          <span class="material-icons-round">visibility</span>
        </button>
        ${o.Status === 'Nacrt' || o.Status === 'Poslano' ? `
          <button class="icon-btn" onclick="markOfferAccepted('${o.Offer_ID}')" title="Prihvaƒáeno">
            <span class="material-icons-round">check_circle</span>
          </button>
        ` : ''}
        <button class="icon-btn danger" onclick="confirmDeleteOffer('${o.Offer_ID}')" title="Obri≈°i">
          <span class="material-icons-round">delete</span>
        </button>
      </div>
    </div>
  `).join('');
    }

    function formatDate(date) {
        if (!date) return '';
        const d = new Date(date);
        return d.toLocaleDateString('hr-HR');
    }

    // ============================================
    // OFFER CREATION - NEW IMPLEMENTATION
    // ============================================

    // State for current offer being created/edited
    let currentOfferState = {
        projectId: null,
        project: null,
        products: [], // Array of products with: { ...productData, included: true, margin: 0, extras: [] }
    };

    function openOfferModal() {
        // Reset state
        currentOfferState = {
            projectId: null,
            project: null,
            products: []
        };

        // Populate project dropdown
        const dropdown = document.getElementById('offer-project-dropdown');
        dropdown.innerHTML = '<option value="">-- Odaberi projekat --</option>' +
            appState.projects.map(p => `<option value="${p.Project_ID}">${p.Client_Name}</option>`).join('');

        // Reset UI
        document.getElementById('offer-modal-title').textContent = 'Nova Ponuda';
        document.getElementById('offer-id').value = '';
        document.getElementById('offer-project-id').value = '';
        document.getElementById('offer-project-select').style.display = 'block';
        document.getElementById('offer-client-info').style.display = 'none';
        document.getElementById('offer-products-section').style.display = 'none';
        document.getElementById('offer-settings-section').style.display = 'none';
        document.getElementById('offer-summary-section').style.display = 'none';
        document.getElementById('offer-save-btn').disabled = true;

        // Reset form values
        document.getElementById('offer-transport').value = 0;
        document.getElementById('offer-onsite').checked = false;
        document.getElementById('offer-discount').value = 0;
        document.getElementById('offer-discount-group').style.display = 'none';
        document.getElementById('offer-valid').value = getDefaultValidDate();
        document.getElementById('offer-notes').value = '';

        openModal('offer-modal');
    }

    // Open offer modal with a pre-selected project
    function openOfferModalForProject(projectId) {
        openOfferModal();

        // Set the project in dropdown
        document.getElementById('offer-project-dropdown').value = projectId;

        // Trigger load
        loadProjectForOffer();
    }

    function getDefaultValidDate() {
        const date = new Date();
        date.setDate(date.getDate() + 14); // 14 days validity
        return date.toISOString().split('T')[0];
    }

    function loadProjectForOffer() {
        const projectId = document.getElementById('offer-project-dropdown').value;
        if (!projectId) {
            document.getElementById('offer-client-info').style.display = 'none';
            document.getElementById('offer-products-section').style.display = 'none';
            document.getElementById('offer-settings-section').style.display = 'none';
            document.getElementById('offer-summary-section').style.display = 'none';
            document.getElementById('offer-save-btn').disabled = true;
            return;
        }

        // Find project in state (already cached!)
        const project = appState.projects.find(p => p.Project_ID === projectId);
        if (!project) return;

        currentOfferState.projectId = projectId;
        currentOfferState.project = project;

        // Show client info
        document.getElementById('offer-client-name').textContent = project.Client_Name;
        document.getElementById('offer-client-address').textContent = project.Address || 'Adresa nije unesena';
        document.getElementById('offer-client-info').style.display = 'block';
        document.getElementById('offer-project-id').value = projectId;

        // Use cached products directly from appState (INSTANT - no backend call!)
        const products = project.products || [];

        // Initialize products with offer-specific fields
        currentOfferState.products = products.map(p => ({
            ...p,
            included: true,
            margin: 0,
            marginType: 'fixed', // 'fixed' or 'percentage'
            extras: []
        }));

        renderOfferProducts();

        // Show sections
        document.getElementById('offer-products-section').style.display = 'block';
        document.getElementById('offer-settings-section').style.display = 'block';
        document.getElementById('offer-summary-section').style.display = 'block';
        document.getElementById('offer-save-btn').disabled = false;

        calculateOfferTotal();
    }

    function renderOfferProducts() {
        const container = document.getElementById('offer-products-list');

        if (currentOfferState.products.length === 0) {
            container.innerHTML = '<p style="color: var(--text-secondary); padding: 20px; text-align: center;">Ovaj projekat nema proizvode. Prvo dodajte proizvode u projekat.</p>';
            return;
        }

        container.innerHTML = currentOfferState.products.map((p, index) => `
            <div class="offer-product-item ${p.included ? 'selected' : ''}" id="offer-product-${index}">
                <div class="offer-product-top">
                    <input type="checkbox" ${p.included ? 'checked' : ''} 
                           onchange="toggleOfferProduct(${index}, this.checked)">
                    <div class="offer-product-main">
                        <div class="offer-product-title">${p.Name}</div>
                        <div class="offer-product-meta">
                            ${p.Height || 0}√ó${p.Width || 0}√ó${p.Depth || 0}mm | Qty: ${p.Quantity || 1}
                        </div>
                    </div>
                    <div class="offer-product-cost-display">
                        <div class="cost-label">Cijena materijala</div>
                        <div class="cost-value">${formatCurrency(p.Material_Cost)}</div>
                    </div>
                </div>
                
                <div class="offer-product-fields">
                    <div class="form-group">
                        <label>Mar≈æa (KM)</label>
                        <input type="number" value="${p.margin || 0}" step="0.01" min="0"
                               onchange="updateOfferProductMargin(${index}, this.value)">
                    </div>
                </div>
                
                <div class="offer-product-extras">
                    <div class="extras-header">
                        <span>Dodaci/Usluge (${(p.extras || []).length})</span>
                        <button class="btn btn-sm btn-secondary" onclick="openExtraModal(${index})">
                            <span class="material-icons-round">add</span> Dodaj
                        </button>
                    </div>
                    <div class="extras-list" id="extras-list-${index}">
                        ${renderProductExtras(p.extras || [], index)}
                    </div>
                </div>
                
                <div class="offer-product-total">
                    <span class="product-total-label">Ukupno za proizvod:</span>
                    <span class="product-total-value" id="product-total-${index}">${formatCurrency(calculateProductTotal(p))}</span>
                </div>
            </div>
        `).join('');
    }

    function renderProductExtras(extras, productIndex) {
        if (!extras || extras.length === 0) {
            return '<p style="font-size: 12px; color: var(--text-tertiary); padding: 8px 0;">Nema dodataka</p>';
        }

        return extras.map((e, i) => `
            <div class="extra-item">
                <span class="extra-item-name">${e.name}</span>
                <span class="extra-item-qty">${e.qty} ${e.unit}</span>
                <span class="extra-item-price">${formatCurrency(e.total)}</span>
                <button class="icon-btn danger" onclick="removeExtra(${productIndex}, ${i})" title="Ukloni">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
        `).join('');
    }

    function calculateProductTotal(product) {
        const materialCost = parseFloat(product.Material_Cost) || 0;
        const margin = parseFloat(product.margin) || 0;
        const extrasTotal = (product.extras || []).reduce((sum, e) => sum + (parseFloat(e.total) || 0), 0);
        const quantity = parseFloat(product.Quantity) || 1;

        return (materialCost + margin + extrasTotal) * quantity;
    }

    function toggleOfferProduct(index, included) {
        currentOfferState.products[index].included = included;

        const item = document.getElementById('offer-product-' + index);
        if (included) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }

        calculateOfferTotal();
    }

    function updateOfferProductMargin(index, value) {
        currentOfferState.products[index].margin = parseFloat(value) || 0;

        // Update product total display
        const product = currentOfferState.products[index];
        document.getElementById('product-total-' + index).textContent = formatCurrency(calculateProductTotal(product));

        calculateOfferTotal();
    }

    function toggleOnsiteDiscount() {
        const checked = document.getElementById('offer-onsite').checked;
        document.getElementById('offer-discount-group').style.display = checked ? 'block' : 'none';

        if (!checked) {
            document.getElementById('offer-discount').value = 0;
        }

        calculateOfferTotal();
    }

    function calculateOfferTotal() {
        let subtotal = 0;

        currentOfferState.products.forEach(p => {
            if (p.included) {
                subtotal += calculateProductTotal(p);
            }
        });

        const transport = parseFloat(document.getElementById('offer-transport').value) || 0;
        const onsite = document.getElementById('offer-onsite').checked;
        const discount = onsite ? (parseFloat(document.getElementById('offer-discount').value) || 0) : 0;

        const total = subtotal + transport - discount;

        document.getElementById('offer-subtotal').textContent = formatCurrency(subtotal);
        document.getElementById('offer-transport-display').textContent = formatCurrency(transport);
        document.getElementById('offer-discount-display').textContent = '-' + formatCurrency(discount);
        document.getElementById('offer-discount-row').style.display = discount > 0 ? 'flex' : 'none';
        document.getElementById('offer-total').textContent = formatCurrency(total);
    }

    // ============================================
    // EXTRAS MODAL
    // ============================================

    function openExtraModal(productIndex) {
        document.getElementById('extra-product-index').value = productIndex;
        document.getElementById('extra-name-select').value = '';
        document.getElementById('extra-name-custom').value = '';
        document.getElementById('extra-name-custom').style.display = 'none';
        document.getElementById('extra-qty').value = 1;
        document.getElementById('extra-unit').value = 'kom';
        document.getElementById('extra-price').value = 0;
        document.getElementById('extra-total').textContent = '0.00 KM';
        document.getElementById('extra-note').value = '';

        document.getElementById('extra-modal').classList.add('active');
        document.getElementById('modal-overlay').classList.add('active');
    }

    function closeExtraModal() {
        document.getElementById('extra-modal').classList.remove('active');
    }

    function onExtraSelect() {
        const value = document.getElementById('extra-name-select').value;
        const customInput = document.getElementById('extra-name-custom');

        if (value === 'custom') {
            customInput.style.display = 'block';
            customInput.focus();
        } else {
            customInput.style.display = 'none';
        }
    }

    function calculateExtraTotal() {
        const qty = parseFloat(document.getElementById('extra-qty').value) || 0;
        const price = parseFloat(document.getElementById('extra-price').value) || 0;
        document.getElementById('extra-total').textContent = formatCurrency(qty * price);
    }

    function addExtraToProduct() {
        const productIndex = parseInt(document.getElementById('extra-product-index').value);
        const selectVal = document.getElementById('extra-name-select').value;
        const customVal = document.getElementById('extra-name-custom').value;

        const name = selectVal === 'custom' ? customVal : selectVal;

        if (!name) {
            showToast('Unesite naziv usluge/dodatka', 'error');
            return;
        }

        const qty = parseFloat(document.getElementById('extra-qty').value) || 0;
        const unit = document.getElementById('extra-unit').value;
        const price = parseFloat(document.getElementById('extra-price').value) || 0;
        const total = qty * price;
        const note = document.getElementById('extra-note').value;

        const extra = { name, qty, unit, price, total, note };

        if (!currentOfferState.products[productIndex].extras) {
            currentOfferState.products[productIndex].extras = [];
        }
        currentOfferState.products[productIndex].extras.push(extra);

        // Update UI
        const extrasList = document.getElementById('extras-list-' + productIndex);
        extrasList.innerHTML = renderProductExtras(currentOfferState.products[productIndex].extras, productIndex);

        // Update product total
        const product = currentOfferState.products[productIndex];
        document.getElementById('product-total-' + productIndex).textContent = formatCurrency(calculateProductTotal(product));

        // Update extras count in header
        const extrasHeader = document.querySelector(`#offer-product-${productIndex} .extras-header span`);
        if (extrasHeader) {
            extrasHeader.textContent = `Dodaci/Usluge (${product.extras.length})`;
        }

        calculateOfferTotal();
        closeExtraModal();
        showToast('Dodatak dodan', 'success');
    }

    function removeExtra(productIndex, extraIndex) {
        currentOfferState.products[productIndex].extras.splice(extraIndex, 1);

        // Update UI
        const extrasList = document.getElementById('extras-list-' + productIndex);
        extrasList.innerHTML = renderProductExtras(currentOfferState.products[productIndex].extras, productIndex);

        // Update product total
        const product = currentOfferState.products[productIndex];
        document.getElementById('product-total-' + productIndex).textContent = formatCurrency(calculateProductTotal(product));

        // Update extras count
        const extrasHeader = document.querySelector(`#offer-product-${productIndex} .extras-header span`);
        if (extrasHeader) {
            extrasHeader.textContent = `Dodaci/Usluge (${product.extras.length})`;
        }

        calculateOfferTotal();
    }

    // ============================================
    // SAVE OFFER
    // ============================================

    function saveOfferData() {
        const projectId = currentOfferState.projectId || document.getElementById('offer-project-id').value;

        if (!projectId) {
            showToast('Odaberite projekat', 'error');
            return;
        }

        // Check if any product is included
        const includedProducts = currentOfferState.products.filter(p => p.included);
        if (includedProducts.length === 0) {
            showToast('Oznaƒçite barem jedan proizvod', 'error');
            return;
        }

        // Prepare offer data
        const offerData = {
            Project_ID: projectId,
            Transport_Cost: parseFloat(document.getElementById('offer-transport').value) || 0,
            Onsite_Assembly: document.getElementById('offer-onsite').checked,
            Onsite_Discount: parseFloat(document.getElementById('offer-discount').value) || 0,
            Valid_Until: document.getElementById('offer-valid').value,
            Notes: document.getElementById('offer-notes').value,
            products: currentOfferState.products.map(p => ({
                Product_ID: p.Product_ID,
                Product_Name: p.Name,
                Quantity: p.Quantity,
                Included: p.included,
                Material_Cost: p.Material_Cost,
                Margin: p.margin,
                Extras: p.extras || []
            }))
        };

        showLoading();
        google.script.run
            .withSuccessHandler(function (result) {
                hideLoading();
                if (result.success) {
                    showToast('Ponuda kreirana: ' + result.data.Offer_Number, 'success');
                    closeModal();

                    // Optimistic update - add offer to local state immediately (no loadAllData!)
                    const project = appState.projects.find(p => p.Project_ID === projectId);
                    const newOffer = {
                        Offer_ID: result.data.Offer_ID,
                        Offer_Number: result.data.Offer_Number,
                        Project_ID: projectId,
                        Client_Name: project?.Client_Name || '',
                        Status: 'Nacrt',
                        Created_Date: new Date().toISOString(),
                        Total_Amount: result.data.Total_Amount || 0,
                        Transport_Cost: offerData.Transport_Cost,
                        Onsite_Assembly: offerData.Onsite_Assembly,
                        Onsite_Discount: offerData.Onsite_Discount,
                        Valid_Until: offerData.Valid_Until,
                        Notes: offerData.Notes,
                        products: currentOfferState.products.filter(p => p.included)
                    };
                    appState.offers.unshift(newOffer);

                    // Update project status to "Ponuƒëeno" if it's "Nacrt"
                    if (project && project.Status === 'Nacrt') {
                        project.Status = 'Ponuƒëeno';
                    }

                    renderOffers();
                    renderProjects();
                    saveToCache(appState);

                    // Switch to offers tab
                    document.querySelector('[data-tab="offers"]').click();
                } else {
                    showToast('Gre≈°ka: ' + result.error, 'error');
                }
            })
            .withFailureHandler(function (err) {
                hideLoading();
                showToast('Gre≈°ka: ' + err.message, 'error');
            })
            .createOfferWithProducts(offerData);
    }

    // ============================================
    // OFFER VIEW/EDIT STATE
    // ============================================
    let viewOfferState = {
        offer: null,
        isEditMode: false,
        originalProducts: []
    };

    function viewOffer(offerId) {
        showLoading();
        google.script.run
            .withSuccessHandler(function (offer) {
                hideLoading();
                if (!offer) {
                    showToast('Ponuda nije pronaƒëena', 'error');
                    return;
                }

                viewOfferState.offer = offer;
                viewOfferState.isEditMode = false;
                viewOfferState.originalProducts = JSON.parse(JSON.stringify(offer.products || []));

                renderOfferViewModal(offer);
                openOfferViewModal();
            })
            .withFailureHandler(function (err) {
                hideLoading();
                showToast('Gre≈°ka pri uƒçitavanju ponude: ' + err.message, 'error');
            })
            .getOffer(offerId);
    }

    function openOfferViewModal() {
        document.getElementById('offer-view-modal').classList.add('active');
        document.getElementById('modal-overlay').classList.add('active');
    }

    function closeOfferViewModal() {
        document.getElementById('offer-view-modal').classList.remove('active');
        document.getElementById('modal-overlay').classList.remove('active');
        viewOfferState.isEditMode = false;
        updateEditModeUI(false);
    }

    function renderOfferViewModal(offer) {
        // Store offer ID
        document.getElementById('view-offer-id').value = offer.Offer_ID;

        // Header info
        document.getElementById('offer-view-title').textContent = 'Ponuda ' + (offer.Offer_Number || '');
        document.getElementById('offer-view-status').textContent = offer.Status || 'Nacrt';
        document.getElementById('offer-view-status').className = 'status-badge ' + getStatusClass(offer.Status);
        document.getElementById('view-offer-status-select').value = offer.Status || 'Nacrt';

        // Offer info cards
        document.getElementById('view-offer-number').textContent = offer.Offer_Number || '-';
        document.getElementById('view-offer-date').textContent = formatDate(offer.Created_Date);
        document.getElementById('view-offer-valid-display').textContent = formatDate(offer.Valid_Until);
        if (offer.Valid_Until) {
            const validDate = new Date(offer.Valid_Until);
            document.getElementById('view-offer-valid-input').value = validDate.toISOString().split('T')[0];
        }

        // Client info
        document.getElementById('view-client-name').textContent = offer.Client_Name || '-';
        document.getElementById('view-client-address').textContent = offer.Address || '-';
        document.getElementById('view-client-phone').textContent = offer.Client_Phone || '-';
        document.getElementById('view-client-email').textContent = offer.Client_Email || '-';

        // Products table
        renderOfferViewProducts(offer.products || []);

        // Settings
        const transport = parseFloat(offer.Transport_Cost) || 0;
        document.getElementById('view-transport-display').textContent = formatCurrency(transport);
        document.getElementById('view-transport-input').value = transport;

        const onsite = offer.Onsite_Assembly === true || offer.Onsite_Assembly === 'true';
        document.getElementById('view-onsite-display').textContent = onsite ? 'Da' : 'Ne';
        document.getElementById('view-onsite-input').checked = onsite;

        const discount = parseFloat(offer.Onsite_Discount) || 0;
        document.getElementById('view-discount-display').textContent = formatCurrency(discount);
        document.getElementById('view-discount-input').value = discount;
        document.getElementById('view-discount-row').style.display = onsite ? 'flex' : 'none';

        // Notes
        document.getElementById('view-notes-display').textContent = offer.Notes || '-';
        document.getElementById('view-notes-input').value = offer.Notes || '';

        // Calculate and display totals
        calculateViewOfferTotals();
    }

    function renderOfferViewProducts(products) {
        const tbody = document.getElementById('view-offer-products');

        if (!products || products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">Nema proizvoda</td></tr>';
            return;
        }

        tbody.innerHTML = products.map((p, index) => {
            const materialCost = parseFloat(p.Material_Cost) || 0;
            const margin = parseFloat(p.Margin) || 0;
            const quantity = parseFloat(p.Quantity) || 1;
            const extrasTotal = (p.extras || []).reduce((sum, e) => sum + (parseFloat(e.Total) || 0), 0);
            const total = (materialCost + margin + extrasTotal) * quantity;
            const included = p.Included === true || p.Included === 'true';

            return `
                <tr class="${included ? '' : 'excluded-product'}" data-product-index="${index}">
                    <td>
                        <div class="product-name-cell">
                            <input type="checkbox" class="product-include-check edit-input" 
                                   data-index="${index}" ${included ? 'checked' : ''} 
                                   style="display:none;" onchange="onProductIncludeChange(${index}, this.checked)">
                            <span class="product-include-indicator ${included ? 'included' : 'excluded'}">
                                ${included ? '‚úì' : '‚úó'}
                            </span>
                            ${p.Product_Name || 'Nepoznat proizvod'}
                        </div>
                    </td>
                    <td>-</td>
                    <td>${quantity}</td>
                    <td>${formatCurrency(materialCost)}</td>
                    <td>
                        <span class="margin-display">${formatCurrency(margin)}</span>
                        <input type="number" class="margin-input edit-input" 
                               data-index="${index}" value="${margin}" 
                               style="display:none; width:80px;" step="0.01" min="0"
                               onchange="onProductMarginChange(${index}, this.value)">
                    </td>
                    <td>${formatCurrency(extrasTotal)}</td>
                    <td class="product-total-cell">${formatCurrency(total)}</td>
                </tr>
            `;
        }).join('');
    }

    function calculateViewOfferTotals() {
        const offer = viewOfferState.offer;
        if (!offer) return;

        const products = offer.products || [];
        let subtotal = 0;

        products.forEach(p => {
            const included = p.Included === true || p.Included === 'true';
            if (included) {
                const materialCost = parseFloat(p.Material_Cost) || 0;
                const margin = parseFloat(p.Margin) || 0;
                const quantity = parseFloat(p.Quantity) || 1;
                const extrasTotal = (p.extras || []).reduce((sum, e) => sum + (parseFloat(e.Total) || 0), 0);
                subtotal += (materialCost + margin + extrasTotal) * quantity;
            }
        });

        const transport = parseFloat(offer.Transport_Cost) || 0;
        const onsite = offer.Onsite_Assembly === true || offer.Onsite_Assembly === 'true';
        const discount = onsite ? (parseFloat(offer.Onsite_Discount) || 0) : 0;
        const total = subtotal + transport - discount;

        document.getElementById('view-subtotal').textContent = formatCurrency(subtotal);
        document.getElementById('view-transport-total').textContent = formatCurrency(transport);
        document.getElementById('view-discount-total').textContent = '-' + formatCurrency(discount);
        document.getElementById('view-discount-total-row').style.display = discount > 0 ? 'flex' : 'none';
        document.getElementById('view-grand-total').textContent = formatCurrency(total);
    }

    function toggleOfferEditMode() {
        viewOfferState.isEditMode = !viewOfferState.isEditMode;
        updateEditModeUI(viewOfferState.isEditMode);
    }

    function updateEditModeUI(isEdit) {
        const editBtn = document.getElementById('offer-edit-toggle-btn');
        const saveBtn = document.getElementById('save-offer-changes-btn');
        const editInputs = document.querySelectorAll('#offer-view-modal .edit-input');
        const displaySpans = document.querySelectorAll('#offer-view-modal .margin-display, #view-offer-valid-display, #view-transport-display, #view-discount-display, #view-onsite-display, #view-notes-display');

        if (isEdit) {
            editBtn.innerHTML = '<span class="material-icons-round">close</span> Otka≈æi';
            editBtn.classList.add('btn-danger');
            editBtn.classList.remove('btn-secondary');
            saveBtn.style.display = 'inline-flex';

            editInputs.forEach(input => input.style.display = input.type === 'checkbox' ? 'inline-block' : 'inline-block');
            displaySpans.forEach(span => span.style.display = 'none');

            // Show product checkboxes
            document.querySelectorAll('.product-include-check').forEach(cb => cb.style.display = 'inline-block');
            document.querySelectorAll('.product-include-indicator').forEach(ind => ind.style.display = 'none');
        } else {
            editBtn.innerHTML = '<span class="material-icons-round">edit</span> Uredi';
            editBtn.classList.remove('btn-danger');
            editBtn.classList.add('btn-secondary');
            saveBtn.style.display = 'none';

            editInputs.forEach(input => input.style.display = 'none');
            displaySpans.forEach(span => span.style.display = 'inline');

            // Hide product checkboxes
            document.querySelectorAll('.product-include-check').forEach(cb => cb.style.display = 'none');
            document.querySelectorAll('.product-include-indicator').forEach(ind => ind.style.display = 'inline');
        }
    }

    function onProductIncludeChange(index, included) {
        if (viewOfferState.offer && viewOfferState.offer.products[index]) {
            viewOfferState.offer.products[index].Included = included;

            const row = document.querySelector(`tr[data-product-index="${index}"]`);
            if (row) {
                row.classList.toggle('excluded-product', !included);
            }

            calculateViewOfferTotals();
        }
    }

    function onProductMarginChange(index, value) {
        if (viewOfferState.offer && viewOfferState.offer.products[index]) {
            viewOfferState.offer.products[index].Margin = parseFloat(value) || 0;

            // Update product total in table
            const product = viewOfferState.offer.products[index];
            const materialCost = parseFloat(product.Material_Cost) || 0;
            const margin = parseFloat(product.Margin) || 0;
            const quantity = parseFloat(product.Quantity) || 1;
            const extrasTotal = (product.extras || []).reduce((sum, e) => sum + (parseFloat(e.Total) || 0), 0);
            const total = (materialCost + margin + extrasTotal) * quantity;

            const row = document.querySelector(`tr[data-product-index="${index}"]`);
            if (row) {
                row.querySelector('.product-total-cell').textContent = formatCurrency(total);
            }

            calculateViewOfferTotals();
        }
    }

    function saveOfferChanges() {
        const offer = viewOfferState.offer;
        if (!offer) return;

        // Collect updated values
        offer.Valid_Until = document.getElementById('view-offer-valid-input').value;
        offer.Transport_Cost = parseFloat(document.getElementById('view-transport-input').value) || 0;
        offer.Onsite_Assembly = document.getElementById('view-onsite-input').checked;
        offer.Onsite_Discount = parseFloat(document.getElementById('view-discount-input').value) || 0;
        offer.Notes = document.getElementById('view-notes-input').value;

        // Recalculate totals
        let subtotal = 0;
        offer.products.forEach(p => {
            const included = p.Included === true || p.Included === 'true';
            if (included) {
                const materialCost = parseFloat(p.Material_Cost) || 0;
                const margin = parseFloat(p.Margin) || 0;
                const quantity = parseFloat(p.Quantity) || 1;
                const extrasTotal = (p.extras || []).reduce((sum, e) => sum + (parseFloat(e.Total) || 0), 0);
                subtotal += (materialCost + margin + extrasTotal) * quantity;
            }
        });

        offer.Subtotal = subtotal;
        offer.Total = subtotal + offer.Transport_Cost - (offer.Onsite_Assembly ? offer.Onsite_Discount : 0);

        showLoading();
        google.script.run
            .withSuccessHandler(function (result) {
                hideLoading();
                if (result.success) {
                    showToast('Ponuda saƒçuvana', 'success');
                    viewOfferState.isEditMode = false;
                    updateEditModeUI(false);

                    // Update display values
                    document.getElementById('view-offer-valid-display').textContent = formatDate(offer.Valid_Until);
                    document.getElementById('view-transport-display').textContent = formatCurrency(offer.Transport_Cost);
                    document.getElementById('view-onsite-display').textContent = offer.Onsite_Assembly ? 'Da' : 'Ne';
                    document.getElementById('view-discount-display').textContent = formatCurrency(offer.Onsite_Discount);
                    document.getElementById('view-notes-display').textContent = offer.Notes || '-';

                    // Update margin displays
                    document.querySelectorAll('.margin-display').forEach((span, index) => {
                        if (offer.products[index]) {
                            span.textContent = formatCurrency(offer.products[index].Margin || 0);
                        }
                    });

                    // Refresh offers list
                    loadAllData();
                } else {
                    showToast('Gre≈°ka: ' + result.error, 'error');
                }
            })
            .withFailureHandler(function (err) {
                hideLoading();
                showToast('Gre≈°ka: ' + err.message, 'error');
            })
            .saveOffer(offer);
    }

    function updateViewOfferStatus() {
        const offerId = document.getElementById('view-offer-id').value;
        const newStatus = document.getElementById('view-offer-status-select').value;

        if (!offerId) return;

        showLoading();
        google.script.run
            .withSuccessHandler(function (result) {
                hideLoading();
                if (result.success) {
                    showToast('Status a≈æuriran', 'success');

                    // Update displayed status
                    viewOfferState.offer.Status = newStatus;
                    document.getElementById('offer-view-status').textContent = newStatus;
                    document.getElementById('offer-view-status').className = 'status-badge ' + getStatusClass(newStatus);

                    // Refresh offers list
                    loadAllData();
                } else {
                    showToast('Gre≈°ka: ' + result.error, 'error');
                }
            })
            .withFailureHandler(function (err) {
                hideLoading();
                showToast('Gre≈°ka: ' + err.message, 'error');
            })
            .updateOfferStatus(offerId, newStatus);
    }

    // ============================================
    // PRINT FUNCTIONALITY
    // ============================================
    function printOfferDocument() {
        const offer = viewOfferState.offer;
        if (!offer) {
            showToast('Nema podataka za print', 'error');
            return;
        }

        // Generate HTML and open in new window for clean printing
        const printHtml = generatePrintHTML(offer);
        const printWindow = window.open('', '_blank', 'width=900,height=700');

        if (!printWindow) {
            showToast('Molimo omoguƒáite popup prozore za printanje', 'warning');
            return;
        }

        printWindow.document.write(printHtml);
        printWindow.document.close();

        // Wait for content to load then print
        printWindow.onload = function () {
            setTimeout(() => {
                printWindow.print();
            }, 250);
        };
    }

    function generatePrintHTML(offer) {
        // Calculate products and totals
        const products = (offer.products || []).filter(p => p.Included === true || p.Included === 'true');

        let subtotal = 0;
        const productRows = products.map((p, index) => {
            const materialCost = parseFloat(p.Material_Cost) || 0;
            const margin = parseFloat(p.Margin) || 0;
            const quantity = parseFloat(p.Quantity) || 1;
            const extrasTotal = (p.extras || []).reduce((sum, e) => sum + (parseFloat(e.Total) || 0), 0);
            const unitPrice = materialCost + margin + extrasTotal;
            const total = unitPrice * quantity;
            subtotal += total;

            return `
                <tr>
                    <td style="text-align:center;">${index + 1}</td>
                    <td>${p.Product_Name || '-'}</td>
                    <td style="text-align:center;">${quantity}</td>
                    <td style="text-align:right;">${unitPrice.toFixed(2)}</td>
                    <td style="text-align:right;">${total.toFixed(2)}</td>
                </tr>
            `;
        }).join('');

        const transport = parseFloat(offer.Transport_Cost) || 0;
        const onsite = offer.Onsite_Assembly === true || offer.Onsite_Assembly === 'true';
        const discount = onsite ? (parseFloat(offer.Onsite_Discount) || 0) : 0;
        const grandTotal = subtotal + transport - discount;

        const transportRow = transport > 0 ? `
            <div class="summary-row">
                <span>Transport</span>
                <span>${formatCurrency(transport)}</span>
            </div>
        ` : '';

        const discountRow = discount > 0 ? `
            <div class="summary-row" style="color: var(--accent);">
                <span>Popust</span>
                <span>-${formatCurrency(discount)}</span>
            </div>
        ` : '';

        const notesSection = offer.Notes ? `
            <div class="notes-section">
                <h4>Napomene</h4>
                <p>${offer.Notes}</p>
            </div>
        ` : '';

        return `
<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <title>Ponuda ${offer.Offer_Number || ''}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #1a1a1a;
            --accent: #6b9b78;
            --accent-light: #9ec5a8;
            --accent-pale: #c8e0ce;
            --accent-soft: rgba(107, 155, 120, 0.08);
            --cream: #fdfcfa;
            --cream-warm: #f8f6f2;
            --blush: rgba(232, 218, 210, 0.3);
            --text-primary: #1a1a1a;
            --text-secondary: #4a5568;
            --text-muted: #64748b;
            --glass-white: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(255, 255, 255, 0.8);
            --glass-shadow: rgba(107, 155, 120, 0.08);
            --border-soft: rgba(0, 0, 0, 0.06);
            --white: #ffffff;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--cream);
            -webkit-font-smoothing: antialiased;
        }
        
        /* Page wrapper table for repeating headers */
        .page-wrapper {
            width: 210mm;
            margin: 0 auto;
            border-collapse: collapse;
            background: var(--white);
        }
        
        .page-wrapper > thead {
            display: table-header-group;
        }
        
        .page-wrapper > tbody {
            display: table-row-group;
        }
        
        .page-wrapper td {
            padding: 0;
            border: none;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 18mm 22mm 16px 22mm;
            border-bottom: 1px solid var(--border-soft);
            background: linear-gradient(180deg, var(--white) 0%, var(--cream-warm) 100%);
        }
        
        .page-content {
            padding: 20px 22mm 20mm 22mm;
        }
        
        /* Legacy .page support */
        .page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm 24mm;
            margin: 0 auto;
            background: linear-gradient(180deg, var(--white) 0%, var(--cream-warm) 100%);
        }
        
        /* Header for legacy */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-soft);
        }
        
        .company-info h1 {
            font-size: 22px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }
        
        .company-info p {
            font-size: 10px;
            color: var(--text-muted);
            margin: 2px 0;
            letter-spacing: 0.2px;
        }
        
        .document-info { text-align: right; }
        
        /* Frosted glass badge */
        .document-type {
            display: inline-block;
            background: linear-gradient(135deg, rgba(129, 168, 141, 0.9) 0%, rgba(184, 212, 190, 0.9) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 10px 22px;
            border-radius: 25px;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(129, 168, 141, 0.2);
        }
        
        .document-number {
            font-size: 15px;
            font-weight: 600;
            color: var(--primary);
            letter-spacing: -0.3px;
        }
        
        .document-date {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 6px;
        }
        
        /* Client - Frosted glass card */
        .client-section {
            background: linear-gradient(135deg, rgba(255,255,255,0.7) 0%, rgba(248,246,242,0.8) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 22px 26px;
            margin-bottom: 30px;
            box-shadow: 
                0 8px 32px rgba(129, 168, 141, 0.06),
                inset 0 1px 0 rgba(255,255,255,0.8);
        }
        
        .client-section h3 {
            font-size: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--accent);
            margin-bottom: 10px;
            opacity: 0.8;
        }
        
        .client-section p { 
            font-size: 11px; 
            color: var(--text-secondary); 
            margin: 4px 0;
            line-height: 1.5;
        }
        
        .client-name { 
            font-size: 17px; 
            font-weight: 600; 
            color: var(--primary);
            margin-bottom: 6px;
        }
        
        /* Table - Soft frosted look */
        .table-wrapper {
            background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(253,252,250,0.8) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.9);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 24px rgba(0,0,0,0.02);
        }
        
        .products-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 8px;
            margin-bottom: 20px;
            background: var(--white);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.04);
        }
        
        .products-table th {
            background: rgba(248, 246, 242, 0.95);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }
        
        .products-table td {
            padding: 11px 12px;
            border-bottom: 1px solid rgba(0,0,0,0.03);
            font-size: 11px;
            color: var(--text-secondary);
            vertical-align: middle;
        }
        
        .products-table td:first-child {
            font-weight: 500;
            color: var(--text-muted);
            text-align: center;
            width: 35px;
        }
        
        .products-table td:last-child { 
            font-weight: 600; 
            color: var(--primary); 
        }
        
        .products-table tbody tr:last-child td { 
            border-bottom: none; 
        }
        
        .products-table tbody tr:nth-child(even) {
            background: rgba(248, 246, 242, 0.4);
        }
        
        /* Legacy table styles */
        table { width: 100%; border-collapse: collapse; }
        
        th {
            background: rgba(253, 252, 250, 0.9);
            color: var(--text-muted);
            font-weight: 500;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-soft);
        }
        
        td {
            padding: 16px;
            border-bottom: 1px solid rgba(0,0,0,0.02);
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        td:last-child { font-weight: 500; color: var(--primary); }
        
        tbody tr:last-child td { border-bottom: none; }
        
        /* Totals - Prominent glass card */
        .totals-section {
            margin-top: 20px;
            background: linear-gradient(135deg, rgba(129, 168, 141, 0.06) 0%, rgba(184, 212, 190, 0.08) 100%);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(129, 168, 141, 0.15);
            border-radius: 16px;
            padding: 20px 24px;
            box-shadow: 
                0 8px 32px rgba(129, 168, 141, 0.08),
                inset 0 1px 0 rgba(255,255,255,0.5);
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .grand-total-row {
            display: flex;
            justify-content: space-between;
            padding: 16px 0 8px 0;
            margin-top: 12px;
            border-top: 1px solid rgba(129, 168, 141, 0.2);
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .grand-total-row span:last-child {
            font-size: 18px;
            color: var(--accent);
        }
        
        /* Notes - Subtle glass */
        .notes-section {
            margin-top: 24px;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0,0,0,0.03);
            border-radius: 12px;
            padding: 16px 20px;
        }
        
        .notes-section h4 {
            font-size: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        
        .notes-section p {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        /* Terms */
        .terms-section {
            margin-top: 28px;
            padding-top: 20px;
        }
        
        .terms-section h4 {
            font-size: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        
        .terms-section ul { 
            margin: 0; 
            padding: 0;
            list-style: none; 
        }
        
        .terms-section li {
            font-size: 10px;
            color: var(--text-secondary);
            padding: 5px 0 5px 16px;
            position: relative;
        }
        
        .terms-section li::before {
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            background: var(--accent-light);
            border-radius: 50%;
        }
        
        .terms-section strong {
            color: var(--primary);
            font-weight: 500;
        }
        
        /* Signatures - Elegant minimal */
        .signatures {
            display: flex;
            justify-content: space-between;
            margin-top: 50px;
            padding-top: 30px;
        }
        
        .signature-block { 
            width: 38%; 
            text-align: center; 
        }
        
        .signature-line {
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--accent-light) 20%, 
                var(--accent-light) 80%, 
                transparent 100%
            );
            margin-bottom: 12px;
            margin-top: 50px;
            opacity: 0.5;
        }
        
        .signature-block p {
            font-size: 8px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Footer */
        .footer {
            margin-top: 35px;
            text-align: center;
            padding-top: 20px;
        }
        
        .footer p {
            font-size: 10px;
            font-weight: 500;
            color: var(--accent);
            letter-spacing: 0.5px;
            opacity: 0.7;
        }
        
        /* Hide print header on screen */
        .print-header-repeat {
            display: none;
        }
        
        @media print {
            body { 
                background: white; 
                print-color-adjust: exact; 
                -webkit-print-color-adjust: exact;
                padding: 0;
                margin: 0;
            }
            
            /* Page wrapper for print */
            .page-wrapper {
                width: 100%;
            }
            
            .page-wrapper > thead {
                display: table-header-group;
            }
            
            .page-wrapper > tbody {
                display: table-row-group;
            }
            
            .page-header {
                padding: 8mm 10mm 12px 10mm;
                background: white;
            }
            
            .page-content {
                padding: 15px 10mm 10mm 10mm;
            }
            
            /* Legacy page */
            .page { 
                width: 100%; 
                padding: 10mm; 
                background: white; 
            }
            
            /* Disable backdrop filters for print */
            .client-section, .totals-section { 
                backdrop-filter: none; 
                -webkit-backdrop-filter: none; 
            }
            
            /* Ensure products table header repeats */
            .products-table thead {
                display: table-header-group;
            }
            
            .products-table tbody {
                display: table-row-group;
            }
            
            /* Page break handling */
            .client-section, .totals-section, .terms-section, .signatures {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            
            @page {
                size: A4;
                margin: 8mm;
            }
        }
        
        @media screen {
            body { 
                background: linear-gradient(135deg, #f5f3f0 0%, #e8e4df 100%); 
                padding: 30px; 
                min-height: 100vh;
            }
            .page { 
                box-shadow: 
                    0 30px 100px rgba(0,0,0,0.08),
                    0 10px 40px rgba(0,0,0,0.04);
                border-radius: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Main wrapper table for repeating header -->
    <table class="page-wrapper">
        <thead>
            <tr>
                <td>
                    <div class="page-header">
                        <div class="company-info">
                            <h1>Va≈°a Firma d.o.o.</h1>
                            <p>Ulica i broj, Grad, Po≈°tanski broj</p>
                            <p>Tel: +387 XX XXX XXX | Email: info@firma.ba</p>
                            <p>ID: xxxxxxxxxx | PDV: xxxxxxxxxx</p>
                        </div>
                        <div class="document-info">
                            <div class="document-type">Ponuda</div>
                            <div class="document-number">${offer.Offer_Number || '-'}</div>
                            <div class="document-date">${formatDate(offer.Created_Date)}</div>
                        </div>
                    </div>
                </td>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="page-content">
                    <!-- Client -->
                    <div class="client-section">
                        <h3>Kupac / Naruƒçilac</h3>
                        <p class="client-name">${offer.Client_Name || '-'}</p>
                        <p>${offer.Address || ''}</p>
                        <p>${[offer.Client_Phone, offer.Client_Email].filter(Boolean).join(' | ') || ''}</p>
                    </div>
                    
                    <!-- Products Table -->
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th style="width:35px; text-align:center;">Br.</th>
                                <th>Proizvod</th>
                                <th style="width:50px; text-align:center;">Kol.</th>
                                <th style="width:90px; text-align:right;">Cijena (KM)</th>
                                <th style="width:90px; text-align:right;">Ukupno (KM)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${productRows}
                        </tbody>
                    </table>
                    
                    <!-- Totals -->
                    <div class="totals-section">
                        <div class="summary-row">
                            <span>Meƒëuzbroj</span>
                            <span>${formatCurrency(subtotal)}</span>
                        </div>
                        ${transportRow}
                        ${discountRow}
                        <div class="grand-total-row">
                            <span>Ukupno za uplatu</span>
                            <span>${formatCurrency(grandTotal)}</span>
                        </div>
                    </div>
                    
                    ${notesSection}
                    
                    <!-- Terms -->
                    <div class="terms-section">
                        <h4>Uslovi</h4>
                        <ul>
                            <li>Ponuda vrijedi do: <strong>${formatDate(offer.Valid_Until)}</strong></li>
                            <li>Plaƒáanje: Avansno ili po dogovoru</li>
                            <li>Rok isporuke: Po dogovoru nakon potvrde narud≈æbe</li>
                            <li>Cijene su izra≈æene u KM (konvertibilnim markama)</li>
                        </ul>
                    </div>
                    
                    <!-- Signatures -->
                    <div class="signatures">
                        <div class="signature-block">
                            <div class="signature-line"></div>
                            <p>Potpis i peƒçat ponuƒëaƒça</p>
                        </div>
                        <div class="signature-block">
                            <div class="signature-line"></div>
                            <p>Potpis naruƒçioca (prihvatanje ponude)</p>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="footer">
                        <p>Hvala Vam na povjerenju!</p>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</body>
</html>
        `;
    }

    function showPrintPreview() {
        // Legacy function - no longer needed
    }

    function closePrintPreview() {
        document.body.classList.remove('print-preview-mode');
        const actionsDiv = document.getElementById('print-preview-actions');
        if (actionsDiv) {
            actionsDiv.style.display = 'none';
        }
    }

    function executePrint() {
        window.print();
    }

    function renderPrintTemplate(offer) {
        // Legacy function - keeping for compatibility
    }

    function markOfferAccepted(offerId) {
        if (confirm('Oznaƒçiti ponudu kao prihvaƒáenu?')) {
            showLoading();
            google.script.run
                .withSuccessHandler(result => {
                    hideLoading();
                    if (result.success) {
                        showToast('Ponuda prihvaƒáena', 'success');
                        loadAllData();
                    }
                })
                .withFailureHandler(err => {
                    hideLoading();
                    showToast('Gre≈°ka: ' + err.message, 'error');
                })
                .updateOfferStatus(offerId, 'Prihvaƒáeno');
        }
    }

    function confirmDeleteOffer(offerId) {
        if (confirm('Obrisati ovu ponudu?')) {
            showLoading();
            google.script.run
                .withSuccessHandler(result => {
                    hideLoading();
                    if (result.success) {
                        showToast('Ponuda obrisana', 'success');
                        loadAllData();
                    }
                })
                .withFailureHandler(err => {
                    hideLoading();
                    showToast('Gre≈°ka: ' + err.message, 'error');
                })
                .deleteOffer(offerId);
        }
    }

    // Search/filter for offers
    document.getElementById('offers-search')?.addEventListener('input', renderOffers);
    document.getElementById('offers-filter')?.addEventListener('change', renderOffers);

    // ============================================
    // ORDERS - Enhanced Implementation
    // ============================================

    // Order creation state
    let orderState = {
        allMaterials: [],
        filteredMaterials: [],
        selectedMaterialIds: new Set(),
        currentOrder: null,
        selectedItemIds: new Set()
    };

    function renderOrders() {
        const container = document.getElementById('orders-list');
        const search = document.getElementById('orders-search')?.value?.toLowerCase() || '';
        const statusFilter = document.getElementById('orders-filter')?.value || '';

        let orders = appState.orders || [];

        // Apply filters
        if (search) {
            orders = orders.filter(o =>
                (o.Order_Number || '').toLowerCase().includes(search) ||
                (o.Supplier_Name || '').toLowerCase().includes(search)
            );
        }
        if (statusFilter) {
            orders = orders.filter(o => o.Status === statusFilter);
        }

        if (orders.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <span class="material-icons-round">local_shipping</span>
                    <h3>Nema narud≈æbi</h3>
                    <p>Kreirajte novu narud≈æbu za materijale</p>
                </div>
            `;
            return;
        }

        container.innerHTML = orders.map(o => {
            const itemCount = (o.items || []).length;
            const receivedCount = (o.items || []).filter(i => i.Status === 'Primljeno').length;
            const progress = itemCount > 0 ? Math.round((receivedCount / itemCount) * 100) : 0;

            return `
                <div class="order-card" onclick="viewOrder('${o.Order_ID}')">
                    <div class="order-card-main">
                        <div class="order-card-header">
                            <span class="order-number">${o.Order_Number}</span>
                            <span class="status-badge ${getStatusClass(o.Status)}">${o.Status || 'Nacrt'}</span>
                        </div>
                        <div class="order-card-supplier">
                            <span class="material-icons-round">store</span>
                            ${o.Supplier_Name || 'Nepoznat dobavljaƒç'}
                        </div>
                        <div class="order-card-meta">
                            <span><span class="material-icons-round">calendar_today</span> ${formatDate(o.Order_Date)}</span>
                            <span><span class="material-icons-round">inventory_2</span> ${itemCount} stavki</span>
                        </div>
                        ${o.Status !== 'Nacrt' && o.Status !== 'Primljeno' ? `
                            <div class="order-progress">
                                <div class="order-progress-bar" style="width: ${progress}%"></div>
                                <span class="order-progress-text">${receivedCount}/${itemCount} primljeno</span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="order-card-amount">
                        ${formatCurrency(o.Total_Amount)}
                    </div>
                </div>
            `;
        }).join('');
    }

    // Search/filter listeners for orders
    document.getElementById('orders-search')?.addEventListener('input', renderOrders);
    document.getElementById('orders-filter')?.addEventListener('change', renderOrders);

    // ============================================
    // ORDERS - OPTIMIZED MATERIAL LOADING FROM CACHE
    // ============================================

    /**
     * Extract orderable materials from cached appState (INSTANT!)
     * This avoids a slow backend call to Google Sheets
     */
    function getOrderableMaterialsFromCache() {
        const materials = [];
        appState.projects.forEach(project => {
            (project.products || []).forEach(product => {
                (product.materials || []).forEach(material => {
                    // Only include materials that are not yet ordered
                    if (material.Status === 'Nije naruƒçeno' || !material.Status) {
                        materials.push({
                            ID: material.ID,
                            Material_Name: material.Material_Name,
                            Quantity: material.Quantity,
                            Unit: material.Unit,
                            Unit_Price: material.Unit_Price,
                            Total_Price: material.Total_Price,
                            Supplier: material.Supplier,
                            Status: material.Status,
                            Product_ID: product.Product_ID,
                            Product_Name: product.Name,
                            Project_ID: project.Project_ID,
                            Project_Name: project.Client_Name,
                            glassItems: material.glassItems
                        });
                    }
                });
            });
        });
        return materials;
    }

    function openOrderModal() {
        // Reset state with new filter Sets
        orderState.allMaterials = [];
        orderState.filteredMaterials = [];
        orderState.selectedMaterialIds = new Set();
        orderState.selectedProjectIds = new Set();
        orderState.selectedProductIds = new Set();

        // Populate supplier dropdown
        const supplierSelect = document.getElementById('order-supplier');
        supplierSelect.innerHTML = '<option value="">Svi dobavljaƒçi</option>' +
            appState.suppliers.map(s => `<option value="${s.Supplier_ID}">${s.Name}</option>`).join('');
        supplierSelect.value = '';

        // Reset other fields
        document.getElementById('order-expected-delivery').value = '';
        document.getElementById('order-notes').value = '';
        document.getElementById('order-items-count').textContent = '0';
        document.getElementById('order-total-amount').textContent = '0.00 KM';
        document.getElementById('create-order-btn').disabled = true;

        // Load from cached appState (INSTANT - no backend call!)
        orderState.allMaterials = getOrderableMaterialsFromCache();

        // Render projects panel
        renderOrderProjectsPanel();

        // Reset products panel
        document.getElementById('order-products-list').innerHTML = '<div class="filter-placeholder">Odaberi projekat</div>';
        document.getElementById('products-selected-count').textContent = '0';

        // Apply filters immediately
        applyOrderFilters();

        openModal('order-modal');
    }

    function renderOrderProjectsPanel() {
        const container = document.getElementById('order-projects-list');
        const projectsWithMaterials = new Set(orderState.allMaterials.map(m => m.Project_ID));

        // Get projects that have orderable materials
        const projects = appState.projects.filter(p =>
            projectsWithMaterials.has(p.Project_ID) || projectsWithMaterials.size === 0
        );

        if (projects.length === 0) {
            container.innerHTML = '<div class="filter-placeholder">Nema projekata</div>';
            return;
        }

        container.innerHTML = projects.map(p => {
            const isSelected = orderState.selectedProjectIds.has(p.Project_ID);
            const materialsCount = orderState.allMaterials.filter(m => m.Project_ID === p.Project_ID).length;
            return `
                <div class="filter-item ${isSelected ? 'selected' : ''}" onclick="toggleOrderProject('${p.Project_ID}')">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleOrderProject('${p.Project_ID}')">
                    <span class="filter-item-name">${p.Client_Name}</span>
                    <span class="filter-item-count">${materialsCount}</span>
                </div>
            `;
        }).join('');

        document.getElementById('projects-selected-count').textContent = orderState.selectedProjectIds.size;
    }

    function toggleOrderProject(projectId) {
        if (orderState.selectedProjectIds.has(projectId)) {
            orderState.selectedProjectIds.delete(projectId);
        } else {
            orderState.selectedProjectIds.add(projectId);
        }

        // Clear product selections if no projects selected
        if (orderState.selectedProjectIds.size === 0) {
            orderState.selectedProductIds.clear();
        }

        renderOrderProjectsPanel();
        renderOrderProductsPanel();
        applyOrderFilters();
    }

    function renderOrderProductsPanel() {
        const container = document.getElementById('order-products-list');

        if (orderState.selectedProjectIds.size === 0) {
            container.innerHTML = '<div class="filter-placeholder">Odaberi projekat</div>';
            document.getElementById('products-selected-count').textContent = '0';
            return;
        }

        // Get products from selected projects that have orderable materials
        const relevantMaterials = orderState.allMaterials.filter(m =>
            orderState.selectedProjectIds.has(m.Project_ID)
        );

        const productMap = new Map();
        relevantMaterials.forEach(m => {
            if (m.Product_ID && !productMap.has(m.Product_ID)) {
                productMap.set(m.Product_ID, {
                    id: m.Product_ID,
                    name: m.Product_Name || 'Nepoznat',
                    count: 0
                });
            }
            if (m.Product_ID) {
                productMap.get(m.Product_ID).count++;
            }
        });

        const products = Array.from(productMap.values());

        if (products.length === 0) {
            container.innerHTML = '<div class="filter-placeholder">Nema proizvoda</div>';
            return;
        }

        container.innerHTML = products.map(p => {
            const isSelected = orderState.selectedProductIds.has(p.id);
            return `
                <div class="filter-item ${isSelected ? 'selected' : ''}" onclick="toggleOrderProduct('${p.id}')">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleOrderProduct('${p.id}')">
                    <span class="filter-item-name">${p.name}</span>
                    <span class="filter-item-count">${p.count}</span>
                </div>
            `;
        }).join('');

        document.getElementById('products-selected-count').textContent = orderState.selectedProductIds.size;
    }

    function toggleOrderProduct(productId) {
        if (orderState.selectedProductIds.has(productId)) {
            orderState.selectedProductIds.delete(productId);
        } else {
            orderState.selectedProductIds.add(productId);
        }
        renderOrderProductsPanel();
        applyOrderFilters();
    }

    function applyOrderFilters() {
        const supplierId = document.getElementById('order-supplier')?.value || '';

        // Get supplier name for comparison (materials store supplier name, not ID)
        let supplierName = '';
        if (supplierId) {
            const supplier = appState.suppliers.find(s => s.Supplier_ID === supplierId);
            supplierName = supplier ? supplier.Name : '';
        }

        orderState.filteredMaterials = orderState.allMaterials.filter(m => {
            // Project filter (if any selected)
            if (orderState.selectedProjectIds.size > 0 && !orderState.selectedProjectIds.has(m.Project_ID)) {
                return false;
            }
            // Product filter (if any selected)
            if (orderState.selectedProductIds.size > 0 && !orderState.selectedProductIds.has(m.Product_ID)) {
                return false;
            }
            // Supplier filter - compare by name since materials store supplier name
            if (supplierName && m.Supplier !== supplierName) {
                return false;
            }
            return true;
        });

        renderOrderMaterialsList();
        document.getElementById('order-materials-count').textContent = orderState.filteredMaterials.length;

        // Update project panel to show which have materials
        if (orderState.allMaterials.length > 0) {
            renderOrderProjectsPanel();
        }
    }

    function renderOrderMaterialsList() {
        const container = document.getElementById('order-materials-list');
        const materials = orderState.filteredMaterials;

        if (materials.length === 0) {
            container.innerHTML = `
                <div class="empty-materials">
                    <span class="material-icons-round">inventory_2</span>
                    <p>${orderState.allMaterials.length === 0
                    ? 'Nema materijala za naruƒçivanje'
                    : 'Primijeni filtere za prikaz'}</p>
                </div>
            `;
            return;
        }

        // Simple rows - no table header
        let html = '';
        materials.forEach(m => {
            const isSelected = orderState.selectedMaterialIds.has(m.ID);
            const total = (parseFloat(m.Quantity) || 0) * (parseFloat(m.Unit_Price) || 0);
            html += `
                <div class="order-material-item ${isSelected ? 'selected' : ''}" onclick="toggleOrderMaterial('${m.ID}')">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleOrderMaterial('${m.ID}')">
                    <div class="mat-info">
                        <div class="mat-name">${m.Material_Name || 'Nepoznat materijal'}</div>
                        <div class="mat-meta">${m.Product_Name || ''} ¬∑ ${m.Project_Name || ''}</div>
                    </div>
                    <div class="mat-qty">${m.Quantity || 0} ${m.Unit || ''}</div>
                    <div class="mat-price">${formatCurrency(total)}</div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function toggleOrderMaterial(materialId) {
        if (orderState.selectedMaterialIds.has(materialId)) {
            orderState.selectedMaterialIds.delete(materialId);
        } else {
            orderState.selectedMaterialIds.add(materialId);
        }
        renderOrderMaterialsList();
        updateOrderSummary();
    }

    function selectAllOrderMaterials() {
        orderState.filteredMaterials.forEach(m => {
            orderState.selectedMaterialIds.add(m.ID);
        });
        renderOrderMaterialsList();
        updateOrderSummary();
    }

    function deselectAllOrderMaterials() {
        orderState.filteredMaterials.forEach(m => {
            orderState.selectedMaterialIds.delete(m.ID);
        });
        renderOrderMaterialsList();
        updateOrderSummary();
    }

    function updateOrderSummary() {
        const count = orderState.selectedMaterialIds.size;
        let total = 0;

        orderState.allMaterials.forEach(m => {
            if (orderState.selectedMaterialIds.has(m.ID)) {
                total += (parseFloat(m.Quantity) || 0) * (parseFloat(m.Unit_Price) || 0);
            }
        });

        document.getElementById('order-items-count').textContent = count;
        document.getElementById('order-total-amount').textContent = formatCurrency(total);

        // Enable button if materials selected (supplier not required)
        document.getElementById('create-order-btn').disabled = count === 0;
    }

    function updateOrderButton() {
        updateOrderSummary();
    }

    function createOrder() {
        const supplierSelect = document.getElementById('order-supplier');
        const supplierId = supplierSelect.value;
        const supplierName = supplierSelect.options[supplierSelect.selectedIndex]?.text || '';

        if (!supplierId) {
            showToast('Odaberite dobavljaƒça', 'error');
            return;
        }

        if (orderState.selectedMaterialIds.size === 0) {
            showToast('Odaberite bar jedan materijal', 'error');
            return;
        }

        const items = [];
        orderState.allMaterials.forEach(m => {
            if (orderState.selectedMaterialIds.has(m.ID)) {
                items.push({
                    Product_Material_ID: m.ID,
                    Product_ID: m.Product_ID,
                    Product_Name: m.Product_Name,
                    Project_ID: m.Project_ID,
                    Material_Name: m.Material_Name,
                    Quantity: m.Quantity,
                    Unit: m.Unit,
                    Expected_Price: m.Unit_Price
                });
            }
        });

        const data = {
            Supplier_ID: supplierId,
            Supplier_Name: supplierName,
            Expected_Delivery: document.getElementById('order-expected-delivery').value || null,
            Notes: document.getElementById('order-notes').value,
            items: items
        };

        showLoading();
        google.script.run
            .withSuccessHandler(result => {
                hideLoading();
                if (result.success) {
                    showToast('Narud≈æba kreirana: ' + result.data.Order_Number, 'success');
                    closeModal();

                    // Update material statuses in local state to "Naruƒçeno"
                    const orderedMaterialIds = new Set(items.map(i => i.Product_Material_ID));
                    appState.projects.forEach(project => {
                        (project.products || []).forEach(product => {
                            (product.materials || []).forEach(material => {
                                if (orderedMaterialIds.has(material.ID)) {
                                    material.Status = 'Naruƒçeno';
                                    material.Order_ID = result.data.Order_ID;
                                }
                            });
                        });
                    });

                    renderProjects(); // Re-render projects to show updated material statuses
                    saveToCache(appState);

                    // Reload orders to get proper item IDs from server
                    loadAllData();
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showToast('Gre≈°ka: ' + err.message, 'error');
            })
            .createOrder(data);
    }

    // ============================================
    // ORDER VIEW MODAL
    // ============================================

    function viewOrder(orderId) {
        const order = appState.orders.find(o => o.Order_ID === orderId);
        if (!order) {
            showToast('Narud≈æba nije pronaƒëena', 'error');
            return;
        }

        orderState.currentOrder = order;
        orderState.selectedItemIds = new Set();
        renderOrderViewModal(order);
        openOrderViewModal();
    }

    function openOrderViewModal() {
        document.getElementById('order-view-modal').classList.add('active');
        document.getElementById('modal-overlay').classList.add('active');
    }

    function closeOrderViewModal() {
        document.getElementById('order-view-modal').classList.remove('active');
        document.getElementById('modal-overlay').classList.remove('active');
        orderState.currentOrder = null;
        orderState.selectedItemIds = new Set();
    }

    function renderOrderViewModal(order) {
        document.getElementById('view-order-id').value = order.Order_ID;
        document.getElementById('order-view-title').textContent = 'Narud≈æba ' + order.Order_Number;

        const statusBadge = document.getElementById('order-view-status');
        statusBadge.textContent = order.Status || 'Nacrt';
        statusBadge.className = 'status-badge ' + getStatusClass(order.Status);

        document.getElementById('view-order-number').textContent = order.Order_Number || '-';
        document.getElementById('view-order-date').textContent = formatDate(order.Order_Date);
        document.getElementById('view-order-delivery').textContent = order.Expected_Delivery ? formatDate(order.Expected_Delivery) : '-';

        // Supplier info
        const supplier = appState.suppliers.find(s => s.Supplier_ID === order.Supplier_ID);
        document.getElementById('view-supplier-name').textContent = order.Supplier_Name || '-';
        document.getElementById('view-supplier-contact').textContent = supplier ?
            [supplier.Phone, supplier.Email].filter(Boolean).join(' | ') : '';

        // Render items
        renderOrderViewItems(order.items || []);

        // Notes
        const notesSection = document.getElementById('view-order-notes-section');
        if (order.Notes) {
            notesSection.style.display = 'block';
            document.getElementById('view-order-notes').textContent = order.Notes;
        } else {
            notesSection.style.display = 'none';
        }

        // Total
        document.getElementById('view-order-total').textContent = formatCurrency(order.Total_Amount);

        // Show/hide buttons based on status
        const sendBtn = document.getElementById('order-send-btn');
        const receivedBtn = document.getElementById('mark-received-btn');

        sendBtn.style.display = order.Status === 'Nacrt' ? 'inline-flex' : 'none';
        receivedBtn.disabled = true;
    }

    function renderOrderViewItems(items) {
        const tbody = document.getElementById('view-order-items');

        if (items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">Nema stavki</td></tr>';
            return;
        }

        tbody.innerHTML = items.map(item => {
            const total = (parseFloat(item.Quantity) || 0) * (parseFloat(item.Expected_Price) || 0);
            const isReceived = item.Status === 'Primljeno';
            const isSelected = orderState.selectedItemIds.has(item.ID);
            const project = appState.projects.find(p => p.Project_ID === item.Project_ID);

            return `
                <tr class="${isReceived ? 'received' : ''}">
                    <td>
                        <input type="checkbox" 
                            ${isReceived ? 'disabled' : ''} 
                            ${isSelected ? 'checked' : ''} 
                            onchange="toggleOrderItem('${item.ID}', this.checked)">
                    </td>
                    <td>${item.Material_Name}</td>
                    <td>
                        <div class="item-project">${project?.Client_Name || '-'}</div>
                        <div class="item-product">${item.Product_Name || ''}</div>
                    </td>
                    <td>${item.Quantity}</td>
                    <td>${item.Unit}</td>
                    <td>${formatCurrency(item.Expected_Price)}</td>
                    <td>${formatCurrency(total)}</td>
                    <td>
                        <span class="status-badge ${getStatusClass(item.Status)}">${item.Status || 'Na ƒçekanju'}</span>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function toggleOrderItem(itemId, checked) {
        if (checked) {
            orderState.selectedItemIds.add(itemId);
        } else {
            orderState.selectedItemIds.delete(itemId);
        }

        const hasSelection = orderState.selectedItemIds.size > 0;
        document.getElementById('mark-received-btn').disabled = !hasSelection;
        document.getElementById('delete-items-btn').disabled = !hasSelection;
    }

    function toggleAllOrderItems(checked) {
        const items = orderState.currentOrder?.items || [];
        orderState.selectedItemIds = new Set();

        if (checked) {
            items.forEach(item => {
                if (item.Status !== 'Primljeno') {
                    orderState.selectedItemIds.add(item.ID);
                }
            });
        }

        renderOrderViewItems(items);
        const hasSelection = orderState.selectedItemIds.size > 0;
        document.getElementById('mark-received-btn').disabled = !hasSelection;
        document.getElementById('delete-items-btn').disabled = !hasSelection;
    }

    function sendOrder() {
        const orderId = document.getElementById('view-order-id').value;

        if (confirm('Oznaƒçiti narud≈æbu kao poslanu?')) {
            showLoading();
            google.script.run
                .withSuccessHandler(result => {
                    hideLoading();
                    if (result.success) {
                        showToast('Narud≈æba poslana', 'success');

                        // Update local state
                        const order = appState.orders.find(o => o.Order_ID === orderId);
                        if (order) {
                            order.Status = 'Poslano';
                            (order.items || []).forEach(i => { i.Status = 'Na ƒçekanju'; });
                        }
                        renderOrders();
                        renderOrderViewModal(order);
                        saveToCache(appState);
                    }
                })
                .withFailureHandler(err => {
                    hideLoading();
                    showToast('Gre≈°ka: ' + err.message, 'error');
                })
                .markOrderSent(orderId);
        }
    }

    function markSelectedAsReceived() {
        const itemIds = Array.from(orderState.selectedItemIds);

        if (itemIds.length === 0) {
            showToast('Odaberite stavke za primanje', 'error');
            return;
        }

        showLoading();
        google.script.run
            .withSuccessHandler(result => {
                hideLoading();
                if (result.success) {
                    showToast('Materijali oznaƒçeni kao primljeni', 'success');

                    // Update local state
                    const order = orderState.currentOrder;
                    if (order) {
                        // Get Product_Material_IDs of received items
                        const receivedMaterialIds = new Set();
                        (order.items || []).forEach(item => {
                            if (itemIds.includes(item.ID)) {
                                item.Status = 'Primljeno';
                                if (item.Product_Material_ID) {
                                    receivedMaterialIds.add(item.Product_Material_ID);
                                }
                            }
                        });

                        // Update material statuses in projects to "Primljeno"
                        appState.projects.forEach(project => {
                            (project.products || []).forEach(product => {
                                (product.materials || []).forEach(material => {
                                    if (receivedMaterialIds.has(material.ID)) {
                                        material.Status = 'Primljeno';
                                    }
                                });
                            });
                        });

                        // Check if all received
                        const allReceived = (order.items || []).every(i => i.Status === 'Primljeno');
                        if (allReceived) {
                            order.Status = 'Primljeno';
                        } else {
                            order.Status = 'Djelomiƒçno primljeno';
                        }
                    }

                    orderState.selectedItemIds = new Set();
                    renderOrders();
                    renderOrderViewModal(order);
                    renderProjects(); // Re-render projects to show updated material statuses
                    saveToCache(appState);
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showToast('Gre≈°ka: ' + err.message, 'error');
            })
            .markMaterialsReceived(itemIds);
    }

    function deleteSelectedOrderItems() {
        const itemIds = Array.from(orderState.selectedItemIds);

        if (itemIds.length === 0) {
            showToast('Odaberite stavke za brisanje', 'error');
            return;
        }

        if (!confirm(`Obrisati ${itemIds.length} selektovanih stavki iz narud≈æbe?`)) {
            return;
        }

        showLoading();
        google.script.run
            .withSuccessHandler(result => {
                hideLoading();
                if (result.success) {
                    showToast('Stavke obrisane iz narud≈æbe', 'success');

                    // Update local state - remove items from current order
                    const order = orderState.currentOrder;
                    if (order) {
                        order.items = (order.items || []).filter(item => !itemIds.includes(item.ID));

                        // Recalculate total
                        order.Total_Amount = order.items.reduce((sum, item) => {
                            return sum + ((parseFloat(item.Quantity) || 0) * (parseFloat(item.Expected_Price) || 0));
                        }, 0);
                    }

                    // Also update in appState.orders
                    const appOrder = appState.orders.find(o => o.Order_ID === order.Order_ID);
                    if (appOrder) {
                        appOrder.items = order.items;
                        appOrder.Total_Amount = order.Total_Amount;
                    }

                    orderState.selectedItemIds = new Set();
                    renderOrders();
                    renderOrderViewModal(order);
                    saveToCache(appState);
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showToast('Gre≈°ka: ' + err.message, 'error');
            })
            .deleteOrderItemsByIds(itemIds);
    }

    function confirmDeleteOrder() {
        const orderId = document.getElementById('view-order-id').value;

        if (confirm('Obrisati ovu narud≈æbu?')) {
            showLoading();
            google.script.run
                .withSuccessHandler(result => {
                    hideLoading();
                    if (result.success) {
                        showToast('Narud≈æba obrisana', 'success');
                        closeOrderViewModal();

                        // Update local state
                        appState.orders = appState.orders.filter(o => o.Order_ID !== orderId);
                        renderOrders();
                        saveToCache(appState);
                    }
                })
                .withFailureHandler(err => {
                    hideLoading();
                    showToast('Gre≈°ka: ' + err.message, 'error');
                })
                .deleteOrder(orderId);
        }
    }

    // ============================================
    // ORDER PRINT
    // ============================================

    function printOrderDocument() {
        const order = orderState.currentOrder;
        if (!order) return;

        const supplier = appState.suppliers.find(s => s.Supplier_ID === order.Supplier_ID);

        // Populate print template
        document.getElementById('print-order-number').textContent = 'Br: ' + order.Order_Number;
        document.getElementById('print-order-date').textContent = 'Datum: ' + formatDate(order.Order_Date);
        document.getElementById('print-supplier-name').textContent = order.Supplier_Name || '-';
        document.getElementById('print-supplier-contact').textContent = supplier ?
            [supplier.Phone, supplier.Email, supplier.Address].filter(Boolean).join(' | ') : '';

        // Items - separate regular materials, glass items, and alu door items into different tables
        const regularItemsBody = document.getElementById('print-regular-items');
        const glassItemsBody = document.getElementById('print-glass-items');
        const glassSection = document.getElementById('print-glass-section');
        const regularTable = document.getElementById('print-regular-items-table');
        const aluDoorSection = document.getElementById('print-alu-door-section');

        let regularHtml = '';
        let glassHtml = '';
        let aluDoorHtml = '';
        let regularIdx = 0;
        let glassIdx = 0;
        let aluDoorIdx = 0;

        (order.items || []).forEach((item) => {
            const project = appState.projects.find(p => p.Project_ID === item.Project_ID);

            // Find glass items for this order item
            let glassItems = [];
            let aluDoorItems = [];
            if (item.Product_Material_ID) {
                // Find the product material to get glass items or alu door items
                for (const proj of appState.projects) {
                    for (const prod of (proj.products || [])) {
                        const pm = (prod.materials || []).find(m => m.ID === item.Product_Material_ID);
                        if (pm && pm.glassItems && pm.glassItems.length > 0) {
                            glassItems = pm.glassItems;
                            break;
                        }
                        if (pm && pm.aluDoorItems && pm.aluDoorItems.length > 0) {
                            aluDoorItems = pm.aluDoorItems;
                            break;
                        }
                    }
                    if (glassItems.length > 0 || aluDoorItems.length > 0) break;
                }
            }

            if (glassItems.length > 0) {
                // Glass material - goes to glass table
                glassIdx++;

                // Calculate total area for this glass material
                const totalArea = glassItems.reduce((sum, gi) => {
                    const qty = parseInt(gi.Qty) || 1;
                    const w = parseFloat(gi.Width) || 0;
                    const h = parseFloat(gi.Height) || 0;
                    return sum + (w * h / 1000000 * qty);
                }, 0);

                // Material header row with total m¬≤
                glassHtml += '<tr class="material-header-row">' +
                    '<td>' + glassIdx + '</td>' +
                    '<td><strong>' + item.Material_Name + '</strong></td>' +
                    '<td></td>' +
                    '<td></td>' +
                    '<td>' + totalArea.toFixed(2) + '</td>' +
                    '</tr>';

                // Individual glass pieces as sub-rows
                glassItems.forEach((gi, giIdx) => {
                    const qty = parseInt(gi.Qty) || 1;
                    const w = parseFloat(gi.Width) || 0;
                    const h = parseFloat(gi.Height) || 0;
                    const edge = gi.Edge_Processing === true || gi.Edge_Processing === 'true';
                    glassHtml += '<tr class="glass-row">' +
                        '<td class="sub-row">' + glassIdx + '.' + (giIdx + 1) + '</td>' +
                        '<td class="sub-row"></td>' +
                        '<td>' + qty + '</td>' +
                        '<td>' + w + ' √ó ' + h + (edge ? ' <span class="edge-badge">bru≈°eno</span>' : '') + '</td>' +
                        '<td></td>' +
                        '</tr>';
                });
            } else if (aluDoorItems.length > 0) {
                // Alu Door material - goes to alu door section
                aluDoorIdx++;

                // Calculate total area for this material
                const totalArea = aluDoorItems.reduce((sum, di) => {
                    const qty = parseInt(di.Qty) || 1;
                    const w = parseFloat(di.Width) || 0;
                    const h = parseFloat(di.Height) || 0;
                    return sum + (w * h / 1000000 * qty);
                }, 0);

                aluDoorHtml += '<div style="margin-bottom: 24px;">';
                aluDoorHtml += '<div style="font-size: 14px; font-weight: 600; color: #1d1d1f; padding: 12px 16px; background: #f5f5f7; border-radius: 8px; margin-bottom: 12px;">' + aluDoorIdx + '. ' + item.Material_Name + ' <span style="font-weight: 400; color: #86868b;">(' + totalArea.toFixed(2) + ' m¬≤)</span></div>';

                // Each door as a card
                aluDoorItems.forEach((di, diIdx) => {
                    const qty = parseInt(di.Qty) || 1;
                    const w = parseFloat(di.Width) || 0;
                    const h = parseFloat(di.Height) || 0;
                    const area = w * h / 1000000 * qty;

                    // Parse hinge positions
                    let hingePositionsStr = '';
                    if (di.Hinge_Layout === 'specijalna' && di.Hinge_Positions) {
                        let positions = di.Hinge_Positions;
                        if (typeof positions === 'string') {
                            try { positions = JSON.parse(positions); } catch (e) { positions = []; }
                        }
                        if (Array.isArray(positions) && positions.length > 0) {
                            hingePositionsStr = positions.map((p, i) => 'Baglama ' + (i + 1) + ': ' + p + 'mm').join(', ');
                        }
                    }

                    aluDoorHtml += '<div style="border: 1px solid #e5e5e5; border-radius: 8px; margin-bottom: 8px; overflow: hidden;">';
                    aluDoorHtml += '<div style="display: flex; align-items: center; gap: 16px; padding: 10px 16px; background: #fafafa; border-bottom: 1px solid #e5e5e5; font-size: 13px;">';
                    aluDoorHtml += '<span style="font-weight: 600; color: #86868b; min-width: 40px;">' + aluDoorIdx + '.' + (diIdx + 1) + '</span>';
                    aluDoorHtml += '<span style="font-weight: 600; color: #1d1d1f;">' + w + ' √ó ' + h + ' mm</span>';
                    aluDoorHtml += '<span style="color: #86868b;">' + qty + ' kom</span>';
                    aluDoorHtml += '<span style="margin-left: auto; font-weight: 500; color: #8b6914;">' + area.toFixed(4) + ' m¬≤</span>';
                    aluDoorHtml += '</div>';
                    aluDoorHtml += '<div style="padding: 12px 16px; font-size: 12px; line-height: 1.8;">';
                    aluDoorHtml += '<div style="display: flex; gap: 8px;"><span style="font-weight: 500; color: #86868b; min-width: 70px;">Ram:</span> ' + (di.Frame_Type || '-') + (di.Frame_Color ? ', ' + di.Frame_Color : '') + '</div>';
                    aluDoorHtml += '<div style="display: flex; gap: 8px;"><span style="font-weight: 500; color: #86868b; min-width: 70px;">Staklo:</span> ' + (di.Glass_Type || '-') + '</div>';
                    aluDoorHtml += '<div style="display: flex; gap: 8px;"><span style="font-weight: 500; color: #86868b; min-width: 70px;">Baglame:</span> ' + (di.Hinge_Type || '-') + ', ' + (di.Hinge_Side || 'lijevo') + (di.Hinge_Color ? ', ' + di.Hinge_Color : '') + '</div>';
                    if (hingePositionsStr) {
                        aluDoorHtml += '<div style="display: flex; gap: 8px;"><span style="font-weight: 500; color: #86868b; min-width: 70px;">Pozicije:</span> ' + hingePositionsStr + '</div>';
                    }
                    if (di.Integrated_Handle === true || di.Integrated_Handle === 'true') {
                        aluDoorHtml += '<div style="display: flex; gap: 8px;"><span style="font-weight: 500; color: #86868b; min-width: 70px;">Ruƒçka:</span> Integrisana</div>';
                    }
                    if (di.Note) {
                        aluDoorHtml += '<div style="display: flex; gap: 8px; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #e5e5e5; font-style: italic; color: #6e6e73;"><span style="font-weight: 500; color: #86868b; min-width: 70px;">Napomena:</span> ' + di.Note + '</div>';
                    }
                    aluDoorHtml += '</div>';
                    aluDoorHtml += '</div>';
                });

                aluDoorHtml += '</div>';
            } else {
                // Regular material - goes to regular table
                regularIdx++;
                regularHtml += '<tr>' +
                    '<td>' + regularIdx + '</td>' +
                    '<td>' + item.Material_Name + '</td>' +
                    '<td>' + item.Quantity + '</td>' +
                    '<td>' + item.Unit + '</td>' +
                    '</tr>';
            }
        });

        // Populate tables and show/hide as needed
        regularItemsBody.innerHTML = regularHtml;
        glassItemsBody.innerHTML = glassHtml;
        document.getElementById('print-alu-door-items').innerHTML = aluDoorHtml;

        // Show/hide tables based on content
        regularTable.style.display = regularHtml ? 'table' : 'none';
        glassSection.style.display = glassHtml ? 'block' : 'none';
        aluDoorSection.style.display = aluDoorHtml ? 'block' : 'none';

        // Notes
        const notesSection = document.getElementById('print-order-notes-section');
        if (order.Notes) {
            notesSection.style.display = 'block';
            document.getElementById('print-order-notes').textContent = order.Notes;
        } else {
            notesSection.style.display = 'none';
        }

        // Delivery
        document.getElementById('print-order-delivery').textContent =
            order.Expected_Delivery ? formatDate(order.Expected_Delivery) : 'Po dogovoru';

        // Open print window
        const printContent = document.getElementById('order-print-container').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Narud≈æbenica ${order.Order_Number}</title>
                <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
                <style>
                    /* ================================================
                       APPLE-STYLE ORDER PRINT TEMPLATE
                       Clean, minimal, professional
                       ================================================ */
                    
                    * { box-sizing: border-box; margin: 0; padding: 0; }
                    
                    body { 
                        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
                        color: #1d1d1f;
                        line-height: 1.5;
                        -webkit-font-smoothing: antialiased;
                    }
                    
                    /* ============ LAYOUT WRAPPER ============ */
                    .print-wrapper-table { width: 100%; border-collapse: collapse; }
                    .print-wrapper-table > tbody > tr > td { padding: 0 48px; }
                    .print-header-repeat { display: table-header-group; }
                    .print-header-repeat td { padding: 48px 48px 0; }
                    
                    /* ============ HEADER ============ */
                    .print-header { 
                        display: flex; 
                        justify-content: space-between; 
                        align-items: flex-start;
                        margin-bottom: 40px; 
                        padding-bottom: 24px;
                        border-bottom: 1px solid #e5e5e5;
                    }
                    
                    .company-info { }
                    .company-name { 
                        font-size: 24px; 
                        font-weight: 700; 
                        color: #1d1d1f;
                        margin-bottom: 8px;
                        letter-spacing: -0.5px;
                    }
                    .company-info p { 
                        font-size: 12px; 
                        color: #86868b; 
                        margin: 2px 0;
                    }
                    
                    .document-info { text-align: right; }
                    .document-info h2 { 
                        font-size: 13px; 
                        font-weight: 600;
                        color: #86868b;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        margin-bottom: 8px;
                    }
                    .document-number { 
                        font-size: 28px; 
                        font-weight: 700; 
                        color: #1d1d1f;
                        letter-spacing: -0.5px;
                    }
                    .document-info p:last-child { 
                        font-size: 13px; 
                        color: #86868b;
                        margin-top: 4px;
                    }
                    
                    /* ============ SUPPLIER CARD ============ */
                    .print-client { 
                        margin: 32px 0;
                        padding: 20px 24px;
                        background: #f5f5f7;
                        border-radius: 12px;
                    }
                    .print-client h3 { 
                        font-size: 11px; 
                        font-weight: 600;
                        color: #86868b; 
                        text-transform: uppercase; 
                        letter-spacing: 1px;
                        margin-bottom: 12px;
                    }
                    .print-client p { 
                        font-size: 15px; 
                        color: #1d1d1f; 
                        margin: 4px 0;
                    }
                    .print-client p:first-of-type {
                        font-weight: 600;
                        font-size: 17px;
                    }
                    
                    /* ============ TABLES ============ */
                    .print-products-table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin: 24px 0;
                    }
                    
                    .print-products-table thead {
                        border-bottom: 2px solid #1d1d1f;
                    }
                    
                    .print-products-table th { 
                        padding: 12px 16px 12px 0;
                        text-align: left; 
                        font-size: 11px; 
                        font-weight: 600; 
                        color: #1d1d1f;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    .print-products-table th:last-child { text-align: right; padding-right: 0; }
                    
                    .print-products-table td { 
                        padding: 16px 16px 16px 0;
                        text-align: left; 
                        border-bottom: 1px solid #e5e5e5; 
                        font-size: 14px; 
                        color: #1d1d1f; 
                        vertical-align: top;
                    }
                    .print-products-table td:last-child { text-align: right; padding-right: 0; }
                    .print-products-table tbody tr:last-child td { border-bottom: none; }
                    
                    /* Material number column */
                    .print-products-table td:first-child { 
                        font-weight: 500;
                        color: #86868b;
                        width: 50px;
                    }
                    
                    /* ============ GLASS SECTION ============ */
                    .glass-section-title {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        font-size: 15px;
                        font-weight: 600;
                        color: #1d1d1f;
                        margin: 40px 0 16px;
                        padding-bottom: 12px;
                        border-bottom: 2px solid #0071e3;
                    }
                    .glass-section-title::before {
                        content: '';
                        display: inline-block;
                        width: 4px;
                        height: 20px;
                        background: #0071e3;
                        border-radius: 2px;
                    }
                    
                    /* Material header row - main glass material */
                    .print-products-table tr.material-header-row { 
                        background: #f5f5f7; 
                    }
                    .print-products-table tr.material-header-row td { 
                        font-weight: 600;
                        padding: 14px 16px 14px 0;
                        border-bottom: 1px solid #d1d1d6;
                    }
                    .print-products-table tr.material-header-row td:first-child {
                        border-radius: 8px 0 0 8px;
                        padding-left: 12px;
                    }
                    .print-products-table tr.material-header-row td:last-child {
                        border-radius: 0 8px 8px 0;
                    }
                    
                    /* Glass sub-rows - individual pieces */
                    .print-products-table tr.glass-row td { 
                        padding: 10px 16px 10px 0;
                        font-size: 13px;
                        color: #6e6e73;
                        border-bottom: 1px solid #f0f0f0;
                    }
                    .print-products-table tr.glass-row td.sub-row { 
                        padding-left: 24px;
                        font-size: 12px;
                        color: #86868b;
                    }
                    
                    /* Edge processing badge */
                    .edge-badge {
                        display: inline-flex;
                        align-items: center;
                        padding: 3px 8px;
                        background: #fef3c7;
                        color: #92400e;
                        border-radius: 6px;
                        font-size: 11px;
                        font-weight: 500;
                        margin-left: 8px;
                    }
                    
                    /* ============ ALU DOOR SECTION ============ */
                    .alu-door-section-title {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        font-size: 15px;
                        font-weight: 600;
                        color: #1d1d1f;
                        margin: 40px 0 16px;
                        padding-bottom: 12px;
                        border-bottom: 2px solid #8b6914;
                    }
                    
                    .alu-door-material-block {
                        margin-bottom: 24px;
                    }
                    
                    .alu-door-material-header {
                        font-size: 14px;
                        font-weight: 600;
                        color: #1d1d1f;
                        padding: 12px 16px;
                        background: #f5f5f7;
                        border-radius: 8px;
                        margin-bottom: 12px;
                    }
                    .alu-door-material-header span {
                        font-weight: 400;
                        color: #86868b;
                    }
                    
                    .alu-door-item-card {
                        border: 1px solid #e5e5e5;
                        border-radius: 8px;
                        margin-bottom: 8px;
                        overflow: hidden;
                    }
                    
                    .alu-door-item-header {
                        display: flex;
                        align-items: center;
                        gap: 16px;
                        padding: 10px 16px;
                        background: #fafafa;
                        border-bottom: 1px solid #e5e5e5;
                        font-size: 13px;
                    }
                    
                    .alu-door-item-header .door-num {
                        font-weight: 600;
                        color: #86868b;
                        min-width: 40px;
                    }
                    .alu-door-item-header .door-dims {
                        font-weight: 600;
                        color: #1d1d1f;
                    }
                    .alu-door-item-header .door-qty {
                        color: #86868b;
                    }
                    .alu-door-item-header .door-area {
                        margin-left: auto;
                        font-weight: 500;
                        color: #8b6914;
                    }
                    
                    .alu-door-item-details {
                        padding: 12px 16px;
                        font-size: 12px;
                        line-height: 1.8;
                    }
                    
                    .alu-door-item-details .detail-row {
                        display: flex;
                        gap: 8px;
                    }
                    .alu-door-item-details .detail-row .label {
                        font-weight: 500;
                        color: #86868b;
                        min-width: 70px;
                    }
                    .alu-door-item-details .detail-row.note {
                        margin-top: 8px;
                        padding-top: 8px;
                        border-top: 1px dashed #e5e5e5;
                        font-style: italic;
                        color: #6e6e73;
                    }
                    
                    /* ============ NOTES ============ */
                    .print-notes { 
                        margin: 32px 0;
                        padding: 20px 24px;
                        background: #fff9e6;
                        border-radius: 12px;
                        border-left: 4px solid #f5a623;
                    }
                    .print-notes h4 { 
                        font-size: 11px; 
                        font-weight: 600;
                        color: #a16207; 
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        margin-bottom: 8px;
                    }
                    .print-notes p { 
                        font-size: 14px; 
                        color: #78350f;
                        line-height: 1.6;
                    }
                    
                    /* ============ DELIVERY / TERMS ============ */
                    .print-terms { 
                        margin: 32px 0;
                        padding: 20px 24px;
                        background: #f5f5f7;
                        border-radius: 12px;
                    }
                    .print-terms h4 { 
                        font-size: 11px; 
                        font-weight: 600;
                        color: #86868b; 
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        margin-bottom: 12px;
                    }
                    .print-terms p { 
                        font-size: 14px; 
                        color: #1d1d1f;
                    }
                    .print-terms strong {
                        color: #0071e3;
                    }
                    
                    /* ============ SIGNATURES ============ */
                    .print-signatures { 
                        display: flex; 
                        justify-content: space-between; 
                        margin-top: 80px; 
                        padding-top: 40px;
                        page-break-inside: avoid; 
                    }
                    .signature-block { 
                        width: 42%; 
                        text-align: center;
                    }
                    .signature-line { 
                        border-top: 1px solid #86868b; 
                        margin-top: 60px; 
                        padding-top: 12px; 
                    }
                    .signature-block p { 
                        font-size: 12px; 
                        color: #86868b;
                    }
                    
                    /* ============ PRINT MEDIA ============ */
                    @media print { 
                        body { 
                            -webkit-print-color-adjust: exact !important; 
                            print-color-adjust: exact !important; 
                        } 
                        @page { 
                            margin: 12mm; 
                            size: A4;
                        }
                        .print-wrapper-table > tbody > tr > td { padding: 0 12mm; }
                        .print-header-repeat td { padding: 12mm 12mm 0; }
                        
                        /* Ensure backgrounds print */
                        .print-client, .print-terms, .print-notes,
                        .print-products-table tr.material-header-row,
                        .edge-badge {
                            -webkit-print-color-adjust: exact !important; 
                            print-color-adjust: exact !important;
                        }
                    }
                </style>
            </head>
            <body>
                ${printContent}
            </body>
            </html>
        `);
        printWindow.document.close();
        setTimeout(() => printWindow.print(), 250);
    }

    // ============================================
    // WORKERS
    // ============================================
    function renderWorkers() {
        const container = document.getElementById('workers-list');

        if (appState.workers.length === 0) {
            container.innerHTML = `
      <div class="empty-state">
        <span class="material-icons-round">people</span>
        <h3>Nema radnika</h3>
        <p>Dodajte radnike u sistem</p>
      </div>
    `;
            return;
        }

        container.innerHTML = appState.workers.map(w => `
    <div class="simple-card">
      <div class="simple-card-info">
        <div class="simple-card-title">${w.Name}</div>
        <div class="simple-card-subtitle">${w.Role || 'Opƒái'} | ${w.Phone || 'Bez telefona'}</div>
      </div>
      <div class="simple-card-meta">
        <span class="status-badge ${w.Status === 'Dostupan' ? 'status-odobreno' : 'status-na-cekanju'}">${w.Status || 'Dostupan'}</span>
        <button class="icon-btn" onclick="editWorker('${w.Worker_ID}')">
          <span class="material-icons-round">edit</span>
        </button>
        <button class="icon-btn danger" onclick="confirmDeleteWorker('${w.Worker_ID}')">
          <span class="material-icons-round">delete</span>
        </button>
      </div>
    </div>
  `).join('');
    }

    function openWorkerModal(worker = null) {
        document.getElementById('worker-modal-title').textContent = worker ? 'Uredi Radnika' : 'Novi Radnik';
        document.getElementById('worker-id').value = worker?.Worker_ID || '';
        document.getElementById('worker-name').value = worker?.Name || '';
        document.getElementById('worker-role').value = worker?.Role || 'Opƒái';
        document.getElementById('worker-phone').value = worker?.Phone || '';

        openModal('worker-modal');
    }

    function editWorker(workerId) {
        const worker = appState.workers.find(w => w.Worker_ID === workerId);
        if (worker) {
            openWorkerModal(worker);
        }
    }

    function saveWorker() {
        const data = {
            Worker_ID: document.getElementById('worker-id').value || null,
            Name: document.getElementById('worker-name').value,
            Role: document.getElementById('worker-role').value,
            Phone: document.getElementById('worker-phone').value
        };

        if (!data.Name) {
            showToast('Unesite ime radnika', 'error');
            return;
        }

        showLoading();
        google.script.run
            .withSuccessHandler(result => {
                hideLoading();
                if (result.success) {
                    showToast(result.message, 'success');
                    closeModal();
                    loadAllData();
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showToast('Gre≈°ka: ' + err.message, 'error');
            })
            .saveWorker(data);
    }

    function confirmDeleteWorker(workerId) {
        if (confirm('Obrisati ovog radnika?')) {
            showLoading();
            google.script.run
                .withSuccessHandler(result => {
                    hideLoading();
                    if (result.success) {
                        showToast('Radnik obrisan', 'success');
                        loadAllData();
                    }
                })
                .withFailureHandler(err => {
                    hideLoading();
                    showToast('Gre≈°ka: ' + err.message, 'error');
                })
                .deleteWorker(workerId);
        }
    }

    // ============================================
    // SUPPLIERS
    // ============================================
    function renderSuppliers() {
        const container = document.getElementById('suppliers-list');

        if (appState.suppliers.length === 0) {
            container.innerHTML = `
      <div class="empty-state">
        <span class="material-icons-round">store</span>
        <h3>Nema dobavljaƒça</h3>
        <p>Dodajte dobavljaƒçe u sistem</p>
      </div>
    `;
            return;
        }

        container.innerHTML = appState.suppliers.map(s => `
    <div class="simple-card">
      <div class="simple-card-info">
        <div class="simple-card-title">${s.Name}</div>
        <div class="simple-card-subtitle">${s.Contact_Person || ''} | ${s.Phone || ''} | ${s.Email || ''}</div>
      </div>
      <div class="simple-card-meta">
        <button class="icon-btn" onclick="editSupplier('${s.Supplier_ID}')">
          <span class="material-icons-round">edit</span>
        </button>
        <button class="icon-btn danger" onclick="confirmDeleteSupplier('${s.Supplier_ID}')">
          <span class="material-icons-round">delete</span>
        </button>
      </div>
    </div>
  `).join('');
    }

    function openSupplierModal(supplier = null) {
        document.getElementById('supplier-modal-title').textContent = supplier ? 'Uredi Dobavljaƒça' : 'Novi Dobavljaƒç';
        document.getElementById('supplier-id').value = supplier?.Supplier_ID || '';
        document.getElementById('supplier-name').value = supplier?.Name || '';
        document.getElementById('supplier-contact').value = supplier?.Contact_Person || '';
        document.getElementById('supplier-phone').value = supplier?.Phone || '';
        document.getElementById('supplier-email').value = supplier?.Email || '';
        document.getElementById('supplier-address').value = supplier?.Address || '';

        openModal('supplier-modal');
    }

    function editSupplier(supplierId) {
        const supplier = appState.suppliers.find(s => s.Supplier_ID === supplierId);
        if (supplier) {
            openSupplierModal(supplier);
        }
    }

    function saveSupplier() {
        const data = {
            Supplier_ID: document.getElementById('supplier-id').value || null,
            Name: document.getElementById('supplier-name').value,
            Contact_Person: document.getElementById('supplier-contact').value,
            Phone: document.getElementById('supplier-phone').value,
            Email: document.getElementById('supplier-email').value,
            Address: document.getElementById('supplier-address').value
        };

        if (!data.Name) {
            showToast('Unesite naziv dobavljaƒça', 'error');
            return;
        }

        showLoading();
        google.script.run
            .withSuccessHandler(result => {
                hideLoading();
                if (result.success) {
                    showToast(result.message, 'success');
                    closeModal();
                    loadAllData();
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showToast('Gre≈°ka: ' + err.message, 'error');
            })
            .saveSupplier(data);
    }

    function confirmDeleteSupplier(supplierId) {
        if (confirm('Obrisati ovog dobavljaƒça?')) {
            showLoading();
            google.script.run
                .withSuccessHandler(result => {
                    hideLoading();
                    if (result.success) {
                        showToast('Dobavljaƒç obrisan', 'success');
                        loadAllData();
                    }
                })
                .withFailureHandler(err => {
                    hideLoading();
                    showToast('Gre≈°ka: ' + err.message, 'error');
                })
                .deleteSupplier(supplierId);
        }
    }

    // ============================================
    // SEARCH EVENT LISTENERS
    // ============================================
    document.getElementById('projects-search')?.addEventListener('input', renderProjects);
    document.getElementById('projects-filter')?.addEventListener('change', renderProjects);
</script>